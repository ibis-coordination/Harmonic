#!/bin/bash
#
# Git pre-commit hook for Harmonic
#
# This hook:
# 1. Scans for accidentally committed secrets/API keys
# 2. Checks for debug code (binding.pry, console.log, etc.)
# 3. Checks for banned .unscoped usage (tenant safety)
# 4. Runs Sorbet type checking
# 5. Runs TypeScript type checking
# 6. Checks if TODO comments were changed and reminds to update TODO_INDEX.md
#
# To install: ./scripts/setup-hooks.sh
# To bypass: git commit --no-verify
#

# Check for secrets (blocks commit if found)
if [[ -x "./scripts/check-secrets.sh" ]]; then
    ./scripts/check-secrets.sh || exit 1
fi

# Check for debug code (blocks commit if found)
if [[ -x "./scripts/check-debug-code.sh" ]]; then
    ./scripts/check-debug-code.sh || exit 1
fi

# Check for banned .unscoped usage (blocks commit if found)
if [[ -x "./scripts/check-tenant-safety.sh" ]]; then
    ./scripts/check-tenant-safety.sh --staged || exit 1
fi

# Run Sorbet type check (blocks commit if types fail)
echo "Running Sorbet type check..."
if docker compose exec -T web bundle exec srb tc > /dev/null 2>&1; then
    echo "✓ Sorbet type check passed"
else
    echo "✗ Sorbet type check failed. Run 'docker compose exec web bundle exec srb tc' for details."
    exit 1
fi

# Run TypeScript type check (blocks commit if types fail)
echo "Running TypeScript type check..."
if docker compose exec -T web npm run typecheck > /dev/null 2>&1; then
    echo "✓ TypeScript type check passed"
else
    echo "✗ TypeScript type check failed. Run 'docker compose exec web npm run typecheck' for details."
    exit 1
fi

# Run TODO index check (advisory only)
if [[ -x "./scripts/check-todo-index.sh" ]]; then
    ./scripts/check-todo-index.sh
fi
