# User Types

This document describes the three user types in Harmonic and their roles in the system.

## Overview

| Type | Has OAuth | Has Parent | Purpose |
|------|-----------|------------|---------|
| `person` | Yes | No | Regular human users who authenticate via OAuth |
| `subagent` | No | Yes (required) | AI agents or automated users managed by a parent |
| `superagent_proxy` | No | No | Synthetic users representing studios for collective agency |

## User Type Details

### Person

A **person** is a regular human user who authenticates via OAuth (Google, GitHub, etc.).

**Characteristics:**
- Has one or more `OauthIdentity` records linking them to external providers
- Cannot have a `parent_id` (validation enforced)
- Can create and manage subagent users
- Can be granted representative permissions to act on behalf of studios

**Created via:** OAuth authentication flow in `OauthIdentity.find_or_create_from_auth`

### Subagent

A **subagent** is an automated user (typically an AI agent) that operates under the authority of a parent person user.

**Characteristics:**
- Must have a `parent_id` pointing to a person user (validation enforced)
- Cannot authenticate directly via OAuth
- Authenticates via API tokens generated by their parent
- Can be represented by their parent user
- Parent can add subagent to studios where parent has invite permission

**Created via:**
- API: `POST /api/v1/users` (creates subagent for authenticated user)
- Service: `ApiHelper#create_subagent`

**Representation:** A parent can represent their subagent via `User#can_represent?`. When representing:
- `current_user` returns the granting_user (for action attribution)
- Actions are attributed to the granting_user (linked to the subagent via TrusteeGrant)
- Parent can stop representation at any time

### Superagent Proxy

A **superagent_proxy** is a synthetic user that enables collective agency. Proxy users allow a superagent (studio) to act as a unified entity.

**Characteristics:**
- Created automatically when a superagent is created (never by users directly)
- Has a generated email like `{uuid}@not-a-real-email.com`
- Cannot have a `parent_id`
- Cannot be a member of the main superagent (validation enforced)
- Cannot be the creator of content (validation enforced)

**Usage:**
- Every superagent automatically creates a proxy user via `Superagent#create_proxy_user!`
- `Superagent.proxy_user` points to this user
- `User#superagent_proxy?` returns true
- `User#proxy_superagent` returns the associated superagent

## Relationship Diagram

```
+-----------------------------------------------------------------+
|                         PERSON USER                              |
|  - Authenticates via OAuth                                       |
|  - Can create subagents                                          |
|  - Can represent superagents                                     |
+---------------------+-------------------+------------------------+
                      |                   |
                      | creates           | can_represent?
                      v                   v
+-----------------------------+   +-----------------------------+
|       SUBAGENT USER         |   |       SUPERAGENT            |
|  - parent_id -> person      |   |  - has proxy_user           |
|  - No OAuth identity        |   |  - has representative role  |
|  - Parent can represent     |   +--------------+--------------+
+-----------------------------+                  |
                                                 | has
                                                 v
                                  +-----------------------------+
                                  |   SUPERAGENT PROXY USER     |
                                  |  - Represents superagent    |
                                  |  - Created automatically    |
                                  |  - Used in representation   |
                                  +-----------------------------+
```

## Authorization Methods

### `User#can_represent?(superagent_or_user)`

Returns true if this user can act on behalf of a superagent or user:
- Proxy user can represent their own superagent
- Superagent member with `representative` role can represent
- Superagent member can represent if `superagent.any_member_can_represent?` is true

### `User#can_edit?(user)`

Returns true if this user can modify another user's profile:
- Users can edit themselves
- Parents can edit their subagents

### `User#can_add_subagent_to_superagent?(subagent, superagent)`

Returns true if this user can add a subagent to a superagent:
- Must be the subagent's parent
- Must have invite permission in the studio

## Validation Rules

| Rule | Enforced By |
|------|-------------|
| Person cannot have parent_id | `User#subagent_must_have_parent` |
| Subagent must have parent_id | `User#subagent_must_have_parent` |
| User cannot be its own parent | `User#subagent_must_have_parent` |
| Proxy user cannot be member of main superagent | `SuperagentMember#proxy_users_not_member_of_main_superagent` |
| Proxy user cannot create content | `Superagent#creator_is_not_superagent_proxy` |

## Related Documentation

- [REPRESENTATION.md](REPRESENTATION.md) - How representation sessions work
- [AGENTS.md](../AGENTS.md) - AI agent integration patterns
