# User Types

This document describes the three user types in Harmonic and their roles in the system.

## Overview

| Type | Has OAuth | Has Parent | Purpose |
|------|-----------|------------|---------|
| `person` | Yes | No | Regular human users who authenticate via OAuth |
| `subagent` | No | Yes (required) | AI agents or automated users managed by a parent |
| `trustee` | No | No | Synthetic users representing studios or delegation relationships |

## User Type Details

### Person

A **person** is a regular human user who authenticates via OAuth (Google, GitHub, etc.).

**Characteristics:**
- Has one or more `OauthIdentity` records linking them to external providers
- Cannot have a `parent_id` (validation enforced)
- Can create and manage subagent users
- Can be granted representative permissions to act on behalf of studios

**Created via:** OAuth authentication flow in `OauthIdentity.find_or_create_from_auth`

### Subagent

A **subagent** is an automated user (typically an AI agent) that operates under the authority of a parent person user.

**Characteristics:**
- Must have a `parent_id` pointing to a person user (validation enforced)
- Cannot authenticate directly via OAuth
- Authenticates via API tokens generated by their parent
- Can be impersonated by their parent user
- Parent can add subagent to studios where parent has invite permission

**Created via:**
- API: `POST /api/v1/users` (creates subagent for authenticated user)
- Service: `ApiHelper#create_subagent`

**Impersonation:** A parent can impersonate their subagent via `User#can_impersonate?`. When impersonating:
- `current_user` returns the subagent
- Actions are attributed to the subagent
- Parent can stop impersonation at any time

### Trustee

A **trustee** is a synthetic user that enables collective agency. Trustees don't represent individual humans—they represent studios or delegation relationships.

**Characteristics:**
- Created automatically (never by users directly)
- Has a generated email like `{uuid}@not-a-real-email.com`
- Cannot have a `parent_id`
- Cannot be a member of the main superagent (validation enforced)
- Cannot be the creator of content (validation enforced)

**Two types of trustees:**

1. **Superagent Trustee**: Every superagent automatically creates a trustee user via `Superagent#create_trustee!`. This trustee represents the superagent as a unified entity.
   - `Superagent.trustee_user` points to this user
   - `User#superagent_trustee?` returns true
   - `User#trustee_superagent` returns the associated superagent

2. **Delegation Trustee**: Created by `TrusteePermission` to represent a delegation relationship between users. (Note: This feature is scaffolded but not yet used in production.)

## Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         PERSON USER                              │
│  - Authenticates via OAuth                                       │
│  - Can create subagents                                          │
│  - Can represent superagents                                     │
└─────────────────────┬───────────────────┬───────────────────────┘
                      │                   │
                      │ creates           │ can_represent?
                      ▼                   ▼
┌─────────────────────────────┐   ┌─────────────────────────────┐
│       SUBAGENT USER         │   │       SUPERAGENT            │
│  - parent_id → person       │   │  - has trustee_user         │
│  - No OAuth identity        │   │  - has representative role  │
│  - Parent can impersonate   │   └──────────────┬──────────────┘
└─────────────────────────────┘                  │
                                                 │ has
                                                 ▼
                                  ┌─────────────────────────────┐
                                  │       TRUSTEE USER          │
                                  │  - Represents superagent    │
                                  │  - Created automatically    │
                                  │  - Used in representation   │
                                  └─────────────────────────────┘
```

## Authorization Methods

### `User#can_impersonate?(user)`

Returns true if this user can act as another user:
- Parent can impersonate their non-archived subagent
- Representative can impersonate a superagent's trustee user (via `can_represent?`)

### `User#can_represent?(superagent_or_user)`

Returns true if this user can act on behalf of a superagent:
- Trustee user can represent their own superagent
- Superagent member with `representative` role can represent
- Superagent member can represent if `superagent.any_member_can_represent?` is true

### `User#can_edit?(user)`

Returns true if this user can modify another user's profile:
- Users can edit themselves
- Parents can edit their subagents

### `User#can_add_subagent_to_superagent?(subagent, superagent)`

Returns true if this user can add a subagent to a superagent:
- Must be the subagent's parent
- Must have invite permission in the studio

## Validation Rules

| Rule | Enforced By |
|------|-------------|
| Person cannot have parent_id | `User#subagent_must_have_parent` |
| Subagent must have parent_id | `User#subagent_must_have_parent` |
| User cannot be its own parent | `User#subagent_must_have_parent` |
| Trustee cannot be member of main superagent | `SuperagentMember#trustee_users_not_member_of_main_superagent` |
| Trustee cannot create content | `ApplicationRecord#creator_is_not_trustee` |

## Related Documentation

- [REPRESENTATION.md](REPRESENTATION.md) - How representation sessions work
- [AGENTS.md](../AGENTS.md) - AI agent integration patterns
