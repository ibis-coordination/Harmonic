<%
base_path = "/u/#{@target_user.handle}/settings/trustee-grants/#{@grant.truncated_id}"
is_granting = @grant.granting_user == @target_user
is_trusted = @grant.trusted_user == @target_user
%>

<%= render 'shared/pulse_breadcrumb', items: [
  ['Home', '/'],
  [@target_user.display_name, "/u/#{@target_user.handle}"],
  ['Settings', "/u/#{@target_user.handle}/settings"],
  ['Trustee Grants', "/u/#{@target_user.handle}/settings/trustee-grants"],
  @grant.display_name
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'people', height: 14, class: 'pulse-resource-icon' %>
        Trustee Grant
      </span>
      <% if @grant.active? %>
        <span class="pulse-tag pulse-tag-success">Active</span>
      <% elsif @grant.pending? %>
        <span class="pulse-tag pulse-tag-warning">Pending</span>
      <% elsif @grant.declined? %>
        <span class="pulse-tag">Declined</span>
      <% elsif @grant.revoked? %>
        <span class="pulse-tag">Revoked</span>
      <% elsif @grant.expired? %>
        <span class="pulse-tag">Expired</span>
      <% end %>
    </div>
    <h1 class="pulse-resource-title"><%= @grant.display_name %></h1>
  </header>

  <div class="pulse-resource-body">
    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Details</h2>
      <table class="pulse-table">
        <tr>
          <th style="width:150px;">Granting User</th>
          <td>
            <a href="/u/<%= @grant.granting_user.handle %>" class="pulse-link">
              <%= @grant.granting_user.display_name || @grant.granting_user.handle %>
            </a>
            <% if is_granting %><span class="pulse-tag pulse-tag-small">You</span><% end %>
          </td>
        </tr>
        <tr>
          <th>Trusted User</th>
          <td>
            <a href="/u/<%= @grant.trusted_user.handle %>" class="pulse-link">
              <%= @grant.trusted_user.display_name || @grant.trusted_user.handle %>
            </a>
            <% if is_trusted %><span class="pulse-tag pulse-tag-small">You</span><% end %>
          </td>
        </tr>
        <tr>
          <th>Allowed Actions</th>
          <td>
            <% if @grant.permissions.present? && @grant.permissions.any? %>
              <% @grant.permissions.each do |action_name, enabled| %>
                <% next unless enabled %>
                <span class="pulse-tag"><%= action_name %></span>
              <% end %>
            <% else %>
              <em>No actions granted</em>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Studio Scope</th>
          <td>
            <% scope = @grant.studio_scope || { "mode" => "all" } %>
            <% case scope["mode"] %>
            <% when "all" %>
              All studios where granting user is a member
            <% when "include" %>
              Only specific studios (<%= scope["studio_ids"]&.count || 0 %>)
            <% when "exclude" %>
              All studios except specific ones (<%= scope["studio_ids"]&.count || 0 %>)
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Created</th>
          <td><%= @grant.created_at.strftime("%Y-%m-%d %H:%M") %></td>
        </tr>
        <% if @grant.accepted_at %>
          <tr>
            <th>Accepted</th>
            <td><%= @grant.accepted_at.strftime("%Y-%m-%d %H:%M") %></td>
          </tr>
        <% end %>
        <% if @grant.declined_at %>
          <tr>
            <th>Declined</th>
            <td><%= @grant.declined_at.strftime("%Y-%m-%d %H:%M") %></td>
          </tr>
        <% end %>
        <% if @grant.revoked_at %>
          <tr>
            <th>Revoked</th>
            <td><%= @grant.revoked_at.strftime("%Y-%m-%d %H:%M") %></td>
          </tr>
        <% end %>
        <tr>
          <th>Expires</th>
          <td>
            <% if @grant.expires_at %>
              <%= @grant.expires_at.strftime("%Y-%m-%d %H:%M") %>
              <% if @grant.expired? %>
                <span class="pulse-tag pulse-tag-danger">Expired</span>
              <% end %>
            <% else %>
              Never
            <% end %>
          </td>
        </tr>
      </table>
    </section>

    <% if @grant.pending? && is_trusted %>
      <section class="pulse-settings-section">
        <h2 class="pulse-section-title">Respond to Request</h2>
        <p>
          <strong><%= @grant.granting_user.display_name || @grant.granting_user.handle %></strong>
          is requesting for you to act on their behalf.
        </p>
        <div class="pulse-action-row">
          <%= form_tag "#{base_path}/actions/accept_trustee_grant", method: :post, style: "display:inline;" do %>
            <button type="submit" class="pulse-action-btn pulse-action-btn-primary">
              <%= octicon "check" %> Accept
            </button>
          <% end %>

          <%= form_tag "#{base_path}/actions/decline_trustee_grant", method: :post, style: "display:inline;" do %>
            <button type="submit" class="pulse-action-btn">
              <%= octicon "x" %> Decline
            </button>
          <% end %>
        </div>
      </section>
    <% end %>

    <% if is_granting && !@grant.revoked? && !@grant.declined? %>
      <section class="pulse-settings-section">
        <h2 class="pulse-section-title">Manage</h2>
        <div class="pulse-action-row">
          <%= form_tag "#{base_path}/actions/revoke_trustee_grant", method: :post, style: "display:inline;" do %>
            <button type="submit" class="pulse-action-btn pulse-action-btn-danger" onclick="return confirm('Are you sure you want to revoke this trustee grant?')">
              <%= octicon "x-circle" %> Revoke Trustee Grant
            </button>
          <% end %>
        </div>
      </section>
    <% end %>

    <% if @grant.active? && is_trusted %>
      <section class="pulse-settings-section">
        <h2 class="pulse-section-title">Represent</h2>
        <% if @current_representation_session %>
          <p class="pulse-text-muted">
            You are currently representing <%= @current_representation_session.trustee_user.display_name %>.
            <a href="/representing" class="pulse-link">End that session</a> before starting a new one.
          </p>
        <% else %>
          <p>
            You can act on behalf of <strong><%= @grant.granting_user.display_name || @grant.granting_user.handle %></strong>
            using this trustee grant.
          </p>
          <div class="pulse-action-row">
            <%= form_tag "#{base_path}/represent", method: :post, style: "display:inline;" do %>
              <button type="submit" class="pulse-action-btn pulse-action-btn-primary">
                <%= octicon "person" %> Start Representing <%= @grant.granting_user.display_name || @grant.granting_user.handle %>
              </button>
            <% end %>
          </div>
        <% end %>
      </section>
    <% end %>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Session History</h2>
      <% if @sessions.empty? %>
        <p class="pulse-empty-content"><em>No representation sessions have occurred yet.</em></p>
      <% else %>
        <p>
          Sessions where <strong><%= @grant.trusted_user.display_name || @grant.trusted_user.handle %></strong>
          acted on behalf of <strong><%= @grant.granting_user.display_name || @grant.granting_user.handle %></strong>:
        </p>
        <table class="pulse-table">
          <thead>
            <tr>
              <th>Session</th>
              <th>Started</th>
              <th>Duration</th>
              <th>Actions</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% @sessions.each do |session| %>
              <tr>
                <td>
                  <a href="<%= session.path %>" class="pulse-link">
                    <code><%= session.truncated_id %></code>
                  </a>
                </td>
                <td><%= session.began_at.strftime("%Y-%m-%d %H:%M") %></td>
                <td>
                  <% duration = (session.elapsed_time / 60).round %>
                  <%= duration %> min<%= duration == 1 ? '' : 's' %>
                </td>
                <td><%= session.action_count %></td>
                <td>
                  <% if session.active? %>
                    <span class="pulse-tag pulse-tag-success">Active</span>
                  <% else %>
                    <span class="pulse-tag">Ended</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </section>
  </div>
</article>
