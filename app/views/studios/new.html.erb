<%= render 'shared/pulse_breadcrumb', items: [
  ['Home', '/'],
  ['Studios', '/studios'],
  'New Studio'
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'heart', height: 14, class: 'pulse-resource-icon' %>
        Studio
      </span>
    </div>
    <h1 class="pulse-resource-title">New Studio</h1>
  </header>

  <p class="pulse-section-description">
    Studios are private groups. Once created, you can invite others to join your studio.
  </p>

  <%= form_with(url: '/studios', class: "pulse-form") do |form| %>
    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Studio Name</h2>
      <p class="pulse-section-description">
        The studio name is displayed at the top of the studio homepage.
      </p>
      <div class="pulse-form-group">
        <%= form.text_field :name, placeholder: 'Studio Name', class: 'pulse-form-input', autofocus: true %>
      </div>
    </section>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Studio Handle</h2>
      <p class="pulse-section-description">
        The studio handle determines the studio's URL path: <code><%= request.protocol %><%= request.host %>/studios/<strong id="handle-example">handle</strong></code>
        <br/>
        Only lowercase letters, numbers, and hyphens are allowed.
      </p>
      <div class="pulse-form-group">
        <span id="already-taken-message" class="pulse-error-message" style="display:none;">That handle is already taken.</span>
        <%= form.text_field :handle, placeholder: 'handle', id: 'handle-input', class: 'pulse-form-input' %>
      </div>
    </section>

    <script>
      const handleInput = document.getElementById('handle-input');
      const handleExample = document.getElementById('handle-example');
      const alreadyTakenMessage = document.getElementById('already-taken-message');
      const validateHandle = function(handle) {
        return /^[a-z0-9-]+$/.test(handle);
      };
      const checkIfAvailable = function(handle) {
        return fetch('/studios/available?handle=' + handle)
          .then(response => response.json())
          .then(data => {
            if (data.available && handleInput.value === handle) {
              handleExample.innerText = handle;
              handleExample.style.textDecoration = 'none';
              alreadyTakenMessage.style.display = 'none';
              handleInput.classList.remove('pulse-form-input-error');
            } else if (!data.available && handleInput.value === handle) {
              handleExample.innerText = handle;
              handleExample.style.textDecoration = 'line-through';
              alreadyTakenMessage.style.display = 'block';
              handleInput.classList.add('pulse-form-input-error');
            } else {
              // noop
            }
          });
      };
      handleInput.addEventListener('input', function() {
        const handle = handleInput.value;
        if (validateHandle(handle)) {
          checkIfAvailable(handle)
        } else {
          handleInput.value = handle.replace(/[^a-z0-9-]/g, '');
        }
      });
    </script>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Studio Description</h2>
      <p class="pulse-section-description">
        The studio description is displayed on the studio homepage.
      </p>
      <div class="pulse-form-group">
        <%= form.text_field :description, placeholder: 'Studio Description (optional)', class: 'pulse-form-input' %>
      </div>
    </section>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Time Zone</h2>
      <p class="pulse-section-description">
        The studio time zone determines when cycles begin and end.
      </p>
      <div class="pulse-form-group">
        <%= form.time_zone_select :timezone, ActiveSupport::TimeZone.all, {}, class: 'pulse-form-select' %>
      </div>
    </section>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Tempo</h2>
      <p class="pulse-section-description">
        How frequently should studio members check in (approximately)?
        This determines the primary cycle duration.
      </p>
      <div class="pulse-form-group">
        <%= form.select :tempo, [['Daily', 'daily'], ['Weekly', 'weekly'], ['Monthly', 'monthly']], { selected: 'weekly' }, class: 'pulse-form-select' %>
      </div>
    </section>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Synchronization Mode</h2>
      <p class="pulse-section-description">
        Which metaphor best describes how your studio will be organized?
        This determines default permissions for new members. You can always change these settings later.
      </p>
      <fieldset class="pulse-radio-group">
        <label class="pulse-radio-label">
          <%= form.radio_button :synchronization_mode, 'improv', checked: true, class: 'pulse-radio-input' %>
          <span><strong>Improv</strong> (no formal leadership roles)</span>
        </label>
        <label class="pulse-radio-label">
          <%= form.radio_button :synchronization_mode, 'orchestra', checked: false, class: 'pulse-radio-input' %>
          <span><strong>Orchestra</strong> (has formal leadership roles)</span>
        </label>
      </fieldset>
    </section>

    <div class="pulse-form-actions">
      <%= form.submit 'Create Studio', class: 'pulse-action-btn' %>
    </div>
  <% end %>
</article>
