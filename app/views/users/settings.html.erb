<h1>Your Settings</h1>

<h2>Profile</h2>
<h3>Image</h3>
Click image to upload a new image.<br/>
<%= render 'shared/profile_image_upload', resource: @current_user, size: 64 %>
<%= form_with url: "#{@current_user.path}/settings/profile" do |form| %>
  <h3>Name</h3>
  <div style="margin-bottom:8px;">
    <%= form.text_field :name, value: @current_user.name, placeholder: 'Name' %>
  </div>
  <h3>Handle</h3>
  <div style="margin-bottom:8px;">
    <%= form.text_field :new_handle, value: @current_user.handle, placeholder: 'handle' %>
  </div>
  <%= form.submit 'Update' %>
<% end %>

<% if @current_user.external_oauth_identities.any? %>
  <h2>Connected Accounts</h2>
  <ul>
  <% @current_user.external_oauth_identities.each do |identity| %>
    <li>
      <%= identity.provider.titleize %> (<a href="<%= identity.url %>"><%= identity.username %></a>)
      Connected <%= time_ago_in_words(identity.created_at) %> ago
    </li>
  <% end %>
  </ul>
<% end %>

<% if @current_tenant.api_enabled? %>
  <h2>Personal API Tokens</h2>
  <p>Personal API tokens are used to authenticate with the API using your own identity. Actions taken through the API using these tokens are attributed to you (<%= @current_user.name %>).</p>
  <% if @current_user.api_tokens.any? %>
    <table>
      <tr>
        <th>Name</th>
        <th>Token</th>
        <th>Created</th>
        <th>Last Used</th>
        <th>Expires</th>
        <th>Active</th>
        <th>View</th>
      </tr>
      <% @current_user.api_tokens.each do |token| %>
        <tr>
          <td><%= token.name || 'Unnamed' %></td>
          <td>
            <code><%= token.obfuscated_token %></code>
            <%= render 'shared/copy_button', text: token.token %>
          </td>
          <td><%= timeago(token.created_at) %></td>
          <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
          <td><%= timeago(token.expires_at) %></td>
          <td><%= token.active? ? 'Yes' : 'No' %></td>
          <td><%= link_to 'View', token.path %></td>
        </tr>
      <% end %>
    </table>
  <% end %>
  <%= button_to 'Create Personal API Token', "#{@current_user.path}/settings/tokens/new", method: :get, class: 'button' %>

  <% if @current_user.person? %>
    <h2>Subagents</h2>
    <p>
      Subagents are virtual identities that you manage.
      These identities can be associated with AI agents and other automated systems that interact with the app through the API.
      You can also impersonate subagents for testing and inspection purposes.
    </p>
    <% if @subagents.any? %>
      <table>
        <tr>
          <th>Name</th>
          <th>Studios</th>
          <th>Created</th>
          <th>Profile</th>
          <th>Impersonate</th>
        </tr>
        <% @subagents.each do |subagent| %>
          <% subagent_studios = subagent.studio_users.map(&:studio) %>
          <% available_studios = @invitable_studios - subagent_studios %>
          <tr>
            <td><%= subagent.name %></td>
            <td>
              <% if subagent_studios.any? %>
                <%= subagent_studios.map { |s| link_to(s.name, s.path) }.join(', ').html_safe %>
              <% else %>
                <em>None</em>
              <% end %>
              <% if available_studios.any? && !subagent.archived? %>
                <br/>
                <%= form_tag "#{subagent.path}/add_to_studio", method: :post, style: "display:inline;margin-top:4px;" do %>
                  <%= select_tag :studio_id, options_for_select(available_studios.map { |s| [s.name, s.id] }), prompt: "Add to studio..." %>
                  <%= submit_tag "Add", class: "button-small" %>
                <% end %>
              <% end %>
            </td>
            <td><%= timeago(subagent.created_at) %></td>
            <td><%= link_to 'View', subagent.path %></td>
            <% if subagent.archived? %>
              <td>Archived</td>
            <% else %>
              <td><%= button_to 'Impersonate', "#{subagent.path}/impersonate", method: :post %></td>
            <% end %>
          </tr>
        <% end %>
      </table>
      <%= button_to 'Create Subagent', "#{@current_user.path}/settings/subagents/new", method: :get, class: 'button' %>
      <h2>Subagent API Tokens</h2>
      <p>Subagents have their own API tokens, which you as the owner are responsible for.</p>
      <% @subagents.each do |subagent| %>
        <% if subagent.api_tokens.any? %>
          <h3><%= subagent.name %></h3>
          <table>
            <tr>
              <th>Name</th>
              <th>Token</th>
              <th>Created</th>
              <th>Last Used</th>
              <th>Expires</th>
              <th>Active</th>
              <th>View</th>
            </tr>
            <% subagent.api_tokens.each do |token| %>
              <tr>
                <td><%= token.name || 'Unnamed' %></td>
                <td>
                  <code><%= token.obfuscated_token %></code>
                  <%= render 'shared/copy_button', text: token.token %>
                </td>
                <td><%= timeago(token.created_at) %></td>
                <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                <td><%= timeago(token.expires_at) %></td>
                <td><%= token.active? ? 'Yes' : 'No' %></td>
                <td><%= link_to 'View', token.path %></td>
              </tr>
            <% end %>
          </table>
        <% else %>
          <h3><%= subagent.name %></h3>
          <p><%= subagent.name %> has no API tokens.</p>
        <% end %>
        <%= button_to "Create API Token for #{subagent.name}", "#{subagent.path}/settings/tokens/new", method: :get, class: 'button' %>
      <% end %>
    <% else %>
      <%= button_to 'Create Subagent', "#{@current_user.path}/settings/subagents/new", method: :get, class: 'button' %>
    <% end %>
  <% end %>
<% end %>