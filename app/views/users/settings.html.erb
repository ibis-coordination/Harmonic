<h1>Your Settings</h1>

<h2>Profile</h2>
<h3>Image</h3>
Click image to upload a new image.<br/>
<%= render 'shared/profile_image_upload', resource: @current_user, size: 64 %>
<%= form_with url: "#{@current_user.path}/settings/profile" do |form| %>
  <h3>Name</h3>
  <div style="margin-bottom:8px;">
    <%= form.text_field :name, value: @current_user.name, placeholder: 'Name' %>
  </div>
  <h3>Handle</h3>
  <div style="margin-bottom:8px;">
    <%= form.text_field :new_handle, value: @current_user.handle, placeholder: 'handle' %>
  </div>
  <%= form.submit 'Update' %>
<% end %>

<h2>UI Version</h2>
<p>Choose which version of the user interface to use.</p>
<div style="display: flex; gap: 12px; margin-top: 8px;">
  <%= form_with url: "#{@current_user.path}/settings/ui_version", method: :post, style: "display: inline;" do |form| %>
    <%= form.hidden_field :ui_version, value: "v1" %>
    <%= form.submit "v1 (Classic)", class: @current_user.ui_version == "v1" ? "button-primary" : "button", disabled: @current_user.ui_version == "v1" %>
  <% end %>
  <%= form_with url: "#{@current_user.path}/settings/ui_version", method: :post, style: "display: inline;" do |form| %>
    <%= form.hidden_field :ui_version, value: "v2" %>
    <%= form.submit "v2 (Beta)", class: @current_user.ui_version == "v2" ? "button-primary" : "button", disabled: @current_user.ui_version == "v2" %>
  <% end %>
</div>
<% if @current_user.ui_version == "v2" %>
  <p style="margin-top: 8px; color: #666;"><em>You're using the beta version of the new UI. Refresh the page after switching to see changes.</em></p>
<% end %>

<% if @current_user.external_oauth_identities.any? %>
  <h2>Connected Accounts</h2>
  <ul>
  <% @current_user.external_oauth_identities.each do |identity| %>
    <li>
      <%= identity.provider.titleize %> (<a href="<%= identity.url %>"><%= identity.username %></a>)
      Connected <%= time_ago_in_words(identity.created_at) %> ago
    </li>
  <% end %>
  </ul>
<% end %>

<% if @current_tenant.api_enabled? %>
  <h2>Personal API Tokens</h2>
  <p>Personal API tokens are used to authenticate with the API using your own identity. Actions taken through the API using these tokens are attributed to you (<%= @current_user.name %>).</p>
  <% if @current_user.api_tokens.any? %>
    <table>
      <tr>
        <th>Name</th>
        <th>Token</th>
        <th>Created</th>
        <th>Last Used</th>
        <th>Expires</th>
        <th>Active</th>
        <th>View</th>
      </tr>
      <% @current_user.api_tokens.each do |token| %>
        <tr>
          <td><%= token.name || 'Unnamed' %></td>
          <td>
            <code><%= token.obfuscated_token %></code>
            <%= render 'shared/copy_button', text: token.token %>
          </td>
          <td><%= timeago(token.created_at) %></td>
          <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
          <td><%= timeago(token.expires_at) %></td>
          <td><%= token.active? ? 'Yes' : 'No' %></td>
          <td><%= link_to 'View', token.path %></td>
        </tr>
      <% end %>
    </table>
  <% end %>
  <%= button_to 'Create Personal API Token', "#{@current_user.path}/settings/tokens/new", method: :get, class: 'button' %>

  <% if @current_user.person? %>
    <h2>Subagents</h2>
    <p>
      Subagents are virtual identities that you manage.
      These identities can be associated with AI agents and other automated systems that interact with the app through the API.
      You can also impersonate subagents for testing and inspection purposes.
    </p>
    <% if @subagents.any? %>
      <% @subagents.each do |subagent| %>
        <% active_superagent_members = subagent.superagent_members.reject(&:archived?) %>
        <% all_subagent_studios = active_superagent_members.map(&:superagent) %>
        <% subagent_studios = all_subagent_studios.reject { |s| s == @current_tenant.main_superagent } %>
        <% available_studios = (@invitable_studios - all_subagent_studios).reject { |s| s == @current_tenant.main_superagent } %>
        <div class="subagent-card" data-controller="subagent-superagent-adder" data-subagent-superagent-adder-remove-url-value="<%= subagent.path %>/remove_from_studio">
          <div class="subagent-card-image">
            <img src="<%= subagent.image_url %>" alt="<%= subagent.name %>">
          </div>
          <div class="subagent-card-content">
            <h3>
              <%= link_to subagent.name, subagent.path %>
              <% if subagent.archived? %>
                <span class="role-badge">Archived</span>
              <% end %>
            </h3>
            <p class="subagent-meta">
              Created <%= timeago(subagent.created_at) %>
              <% unless subagent.archived? %>
                &bull; <%= button_to 'Impersonate', "#{subagent.path}/impersonate", method: :post, class: 'button-small' %>
              <% end %>
            </p>

            <h4>Studio Memberships</h4>
            <ul class="studio-membership-list" data-subagent-superagent-adder-target="superagentList">
              <% if subagent_studios.any? %>
                <% subagent_studios.each do |s| %>
                  <li class="studio-item" data-superagent-id="<%= s.id %>">
                    <%= link_to s.name, s.path %>
                    <button type="button" class="button-small button-danger"
                            data-action="subagent-superagent-adder#remove"
                            data-superagent-id="<%= s.id %>"
                            data-superagent-name="<%= s.name %>">
                      Remove from studio
                    </button>
                  </li>
                <% end %>
              <% else %>
                <li class="none-message"><em>Not a member of any studios</em></li>
              <% end %>
            </ul>

            <% if !subagent.archived? %>
              <form data-subagent-superagent-adder-target="form" data-action="submit->subagent-superagent-adder#add" action="<%= subagent.path %>/add_to_studio" method="post" class="add-to-studio-form" style="<%= available_studios.empty? ? 'display:none;' : '' %>">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <select name="superagent_id" data-subagent-superagent-adder-target="select">
                  <option value="">Add to studio...</option>
                  <% available_studios.each do |s| %>
                    <option value="<%= s.id %>"><%= s.name %></option>
                  <% end %>
                </select>
                <button type="submit" class="button-small">Add</button>
              </form>
            <% end %>
          </div>
        </div>
      <% end %>
      <%= button_to 'Create Subagent', "#{@current_user.path}/settings/subagents/new", method: :get, class: 'button' %>
      <h2>Subagent API Tokens</h2>
      <p>Subagents have their own API tokens, which you as the owner are responsible for.</p>
      <% @subagents.each do |subagent| %>
        <% if subagent.api_tokens.any? %>
          <h3><%= subagent.name %></h3>
          <table>
            <tr>
              <th>Name</th>
              <th>Token</th>
              <th>Created</th>
              <th>Last Used</th>
              <th>Expires</th>
              <th>Active</th>
              <th>View</th>
            </tr>
            <% subagent.api_tokens.each do |token| %>
              <tr>
                <td><%= token.name || 'Unnamed' %></td>
                <td>
                  <code><%= token.obfuscated_token %></code>
                  <%= render 'shared/copy_button', text: token.token %>
                </td>
                <td><%= timeago(token.created_at) %></td>
                <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                <td><%= timeago(token.expires_at) %></td>
                <td><%= token.active? ? 'Yes' : 'No' %></td>
                <td><%= link_to 'View', token.path %></td>
              </tr>
            <% end %>
          </table>
        <% else %>
          <h3><%= subagent.name %></h3>
          <p><%= subagent.name %> has no API tokens.</p>
        <% end %>
        <%= button_to "Create API Token for #{subagent.name}", "#{subagent.path}/settings/tokens/new", method: :get, class: 'button' %>
      <% end %>
    <% else %>
      <%= button_to 'Create Subagent', "#{@current_user.path}/settings/subagents/new", method: :get, class: 'button' %>
    <% end %>
  <% end %>
<% end %>