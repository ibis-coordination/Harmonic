<%= render 'shared/pulse_breadcrumb', items: [
  [@current_tenant.subdomain, '/'],
  'Users',
  [@settings_user.display_name, @settings_user.path],
  'Settings'
] %>

<% is_own_settings = @settings_user == @current_user %>

<article class="pulse-user-profile">
  <header class="pulse-user-header">
    <div class="pulse-user-avatar-large">
      <img src="<%= @settings_user.image_url %>" alt="<%= @settings_user.display_name %>" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
    </div>
    <div class="pulse-user-info">
      <h1 class="pulse-user-name"><%= @settings_user.display_name %></h1>
      <p class="pulse-user-handle">@<%= @settings_user.handle %></p>
      <% if @settings_user.subagent? %>
        <span class="pulse-badge" title="This is a subagent managed by <%= @settings_user.parent&.display_name %>">subagent</span>
      <% end %>
    </div>
    <div class="pulse-user-actions">
      <a href="<%= @settings_user.path %>" class="pulse-action-btn">
        <%= octicon 'person', height: 14 %>
        View Profile
      </a>
    </div>
  </header>

  <%# Profile Section %>
  <%= render 'shared/pulse_accordion', title: 'Profile', open: true do %>
    <%# Profile image upload has its own form so must be outside the main profile form %>
    <div class="pulse-form-section">
      <label class="pulse-form-label">Profile Image</label>
      <p class="pulse-form-hint">Click the image to upload a new one</p>
      <%= render 'shared/profile_image_upload', resource: @settings_user, size: 64 %>
    </div>

    <%= form_with url: "#{@settings_user.path}/settings/profile", class: 'pulse-form' do |form| %>
      <div class="pulse-form-section">
        <label class="pulse-form-label" for="name">Display Name</label>
        <%= form.text_field :name, value: @settings_user.name, placeholder: 'Your name', class: 'pulse-input' %>
      </div>

      <div class="pulse-form-section">
        <label class="pulse-form-label" for="new_handle">Handle</label>
        <div class="pulse-input-prefix-wrapper">
          <span class="pulse-input-prefix">@</span>
          <%= form.text_field :new_handle, value: @settings_user.handle, placeholder: 'handle', class: 'pulse-input pulse-input-with-prefix' %>
        </div>
        <p class="pulse-form-hint">This is your unique identifier used in URLs and mentions</p>
      </div>

      <div class="pulse-form-actions">
        <%= form.submit 'Save Changes', class: 'pulse-action-btn-primary' %>
      </div>
    <% end %>
  <% end %>

  <% if is_own_settings %>
    <% if @settings_user.external_oauth_identities.any? %>
      <%# Connected Accounts Section %>
      <%= render 'shared/pulse_accordion', title: 'Connected Accounts', count: @settings_user.external_oauth_identities.count do %>
        <div class="pulse-connected-accounts-list">
          <% @settings_user.external_oauth_identities.each do |identity| %>
            <div class="pulse-connected-account-item">
              <div class="pulse-connected-account-info">
                <span class="pulse-connected-account-provider"><%= identity.provider.titleize %></span>
                <a href="<%= identity.url %>" class="pulse-connected-account-username">@<%= identity.username %></a>
              </div>
              <span class="pulse-connected-account-date">Connected <%= time_ago_in_words(identity.created_at) %> ago</span>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <% # Two-Factor Authentication Section (only for identity provider users) %>
    <% identity_for_2fa = OmniAuthIdentity.find_by(email: @settings_user.email) %>
    <% if identity_for_2fa %>
      <%= render 'shared/pulse_accordion', title: 'Two-Factor Authentication' do %>
        <p class="pulse-form-hint" style="margin-bottom:16px;">
          Add an extra layer of security to your account by requiring a verification code in addition to your password.
        </p>
        <% if identity_for_2fa.otp_enabled %>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <span class="pulse-badge pulse-badge-success">Enabled</span>
            <span class="pulse-form-hint">since <%= identity_for_2fa.otp_enabled_at.strftime('%B %d, %Y') %></span>
          </div>
          <p class="pulse-form-hint" style="margin-bottom:16px;">
            You have <strong><%= identity_for_2fa.remaining_recovery_codes_count %></strong> recovery codes remaining.
          </p>
          <div class="pulse-form-actions">
            <a href="<%= two_factor_settings_path %>" class="pulse-action-btn">
              <%= octicon 'shield-lock', height: 14 %>
              Manage 2FA
            </a>
          </div>
        <% else %>
          <div class="pulse-form-actions">
            <a href="<%= two_factor_setup_path %>" class="pulse-action-btn">
              <%= octicon 'shield-lock', height: 14 %>
              Enable Two-Factor Authentication
            </a>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <% if @current_tenant.api_enabled? %>
    <%# API Tokens Section %>
    <%= render 'shared/pulse_accordion', title: 'API Tokens', count: @settings_user.api_tokens.count do %>
      <p class="pulse-form-hint" style="margin-bottom:16px;">
        API tokens authenticate requests to the API. Actions taken through the API using these tokens are attributed to <%= @settings_user.name %>.
      </p>
      <% if @settings_user.api_tokens.any? %>
        <div class="pulse-table-wrapper">
          <table class="pulse-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Token</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Expires</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @settings_user.api_tokens.each do |token| %>
                <tr>
                  <td><%= token.name || 'Unnamed' %></td>
                  <td>
                    <code class="pulse-code"><%= token.obfuscated_token %></code>
                    <% if token.plaintext_token.present? %>
                      <%= render 'shared/copy_button', text: token.plaintext_token %>
                    <% end %>
                  </td>
                  <td><%= timeago(token.created_at) %></td>
                  <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                  <td><%= timeago(token.expires_at) %></td>
                  <td>
                    <% if token.active? %>
                      <span class="pulse-badge pulse-badge-success">Active</span>
                    <% else %>
                      <span class="pulse-badge pulse-badge-muted">Inactive</span>
                    <% end %>
                  </td>
                  <td><a href="<%= token.path %>" class="pulse-link">View</a></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
      <% if @current_user.person? %>
        <div class="pulse-form-actions" style="margin-top:16px;">
          <a href="<%= @settings_user.path %>/settings/tokens/new" class="pulse-action-btn">
            <%= octicon 'key', height: 14 %>
            Create API Token
          </a>
        </div>
      <% end %>
    <% end %>

    <%# Webhooks Section %>
    <%= render 'shared/pulse_accordion', title: 'Webhooks' do %>
      <p class="pulse-form-hint" style="margin-bottom:16px;">
        Webhooks allow you to receive notifications at an external URL when events occur.
      </p>
      <div class="pulse-form-actions">
        <a href="<%= @settings_user.path %>/settings/webhooks" class="pulse-action-btn">
          <%= octicon 'webhook', height: 14 %>
          Manage Webhooks
        </a>
      </div>
    <% end %>

    <% if @settings_user.person? && is_own_settings %>
      <%# Subagents Section %>
      <%= render 'shared/pulse_accordion', title: 'Subagents', count: @subagents.count do %>
        <p class="pulse-form-hint" style="margin-bottom:16px;">
          Subagents are virtual identities that you manage. These identities can be associated with AI agents and other automated systems that interact with the app through the API.
        </p>

        <% if @subagents.any? %>
          <div class="pulse-subagents-list">
            <% @subagents.each do |subagent| %>
              <% active_superagent_members = subagent.superagent_members.reject(&:archived?) %>
              <% all_subagent_studios = active_superagent_members.map(&:superagent) %>
              <% subagent_studios = all_subagent_studios.reject { |s| s == @current_tenant.main_superagent } %>
              <% available_studios = (@invitable_studios - all_subagent_studios).reject { |s| s == @current_tenant.main_superagent } %>

              <div class="pulse-subagent-card" data-controller="subagent-superagent-adder" data-subagent-superagent-adder-remove-url-value="<%= subagent.path %>/remove_from_studio">
                <div class="pulse-subagent-header">
                  <img src="<%= subagent.image_url %>" alt="<%= subagent.name %>" class="pulse-subagent-avatar">
                  <div class="pulse-subagent-info">
                    <div class="pulse-subagent-name">
                      <a href="<%= subagent.path %>"><%= subagent.name %></a>
                      <% if subagent.archived? %>
                        <span class="pulse-badge pulse-badge-muted">Archived</span>
                      <% end %>
                    </div>
                    <span class="pulse-subagent-meta">Created <%= timeago(subagent.created_at) %></span>
                  </div>
                  <div class="pulse-subagent-actions">
                    <% unless subagent.archived? %>
                      <%= button_to 'Impersonate', "#{subagent.path}/impersonate", method: :post, class: 'pulse-action-btn-small' %>
                    <% end %>
                    <a href="<%= subagent.path %>/settings" class="pulse-action-btn-small">Settings</a>
                  </div>
                </div>

                <div class="pulse-subagent-studios">
                  <label class="pulse-form-label">Studio Memberships</label>
                  <ul class="pulse-studio-membership-list" data-subagent-superagent-adder-target="superagentList">
                    <% if subagent_studios.any? %>
                      <% subagent_studios.each do |s| %>
                        <li class="pulse-studio-membership-item" data-superagent-id="<%= s.id %>">
                          <a href="<%= s.path %>"><%= s.name %></a>
                          <button type="button" class="pulse-action-btn-small pulse-action-btn-danger"
                                  data-action="subagent-superagent-adder#remove"
                                  data-superagent-id="<%= s.id %>"
                                  data-superagent-name="<%= s.name %>">
                            Remove
                          </button>
                        </li>
                      <% end %>
                    <% else %>
                      <li class="pulse-studio-membership-empty"><em>Not a member of any studios</em></li>
                    <% end %>
                  </ul>

                  <% if !subagent.archived? && available_studios.any? %>
                    <form data-subagent-superagent-adder-target="form" data-action="submit->subagent-superagent-adder#add" action="<%= subagent.path %>/add_to_studio" method="post" class="pulse-add-studio-form">
                      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                      <select name="superagent_id" data-subagent-superagent-adder-target="select" class="pulse-select">
                        <option value="">Add to studio...</option>
                        <% available_studios.each do |s| %>
                          <option value="<%= s.id %>"><%= s.name %></option>
                        <% end %>
                      </select>
                      <button type="submit" class="pulse-action-btn-small">Add</button>
                    </form>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="pulse-form-actions" style="margin-top:16px;">
          <a href="<%= @settings_user.path %>/settings/subagents/new" class="pulse-action-btn">
            <%= octicon 'person-add', height: 14 %>
            Create Subagent
          </a>
        </div>
      <% end %>

      <% if @subagents.any? %>
        <%# Subagent API Tokens Section %>
        <%= render 'shared/pulse_accordion', title: 'Subagent API Tokens' do %>
          <p class="pulse-form-hint" style="margin-bottom:16px;">
            Subagents have their own API tokens, which you as the owner are responsible for.
          </p>

          <% @subagents.each do |subagent| %>
            <div class="pulse-subagent-tokens-section">
              <h4 class="pulse-subsection-title"><%= subagent.name %></h4>
              <% if subagent.api_tokens.any? %>
                <div class="pulse-table-wrapper">
                  <table class="pulse-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Token</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th>Expires</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% subagent.api_tokens.each do |token| %>
                        <tr>
                          <td><%= token.name || 'Unnamed' %></td>
                          <td>
                            <code class="pulse-code"><%= token.obfuscated_token %></code>
                            <% if token.plaintext_token.present? %>
                              <%= render 'shared/copy_button', text: token.plaintext_token %>
                            <% end %>
                          </td>
                          <td><%= timeago(token.created_at) %></td>
                          <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                          <td><%= timeago(token.expires_at) %></td>
                          <td>
                            <% if token.active? %>
                              <span class="pulse-badge pulse-badge-success">Active</span>
                            <% else %>
                              <span class="pulse-badge pulse-badge-muted">Inactive</span>
                            <% end %>
                          </td>
                          <td><a href="<%= token.path %>" class="pulse-link">View</a></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <p class="pulse-form-hint"><%= subagent.name %> has no API tokens.</p>
              <% end %>
              <div class="pulse-form-actions" style="margin-top:12px;">
                <a href="<%= subagent.path %>/settings/tokens/new" class="pulse-action-btn-small">
                  <%= octicon 'key', height: 12 %>
                  Create Token
                </a>
              </div>
            </div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</article>
