<%= render 'shared/pulse_breadcrumb', items: [
  [@current_tenant.subdomain, '/'],
  'Users',
  [@settings_user.display_name, @settings_user.path],
  'Settings'
] %>

<% is_own_settings = @settings_user == @current_user %>

<article class="pulse-user-profile">
  <header class="pulse-user-header">
    <div class="pulse-user-avatar-large">
      <img src="<%= @settings_user.image_url %>" alt="<%= @settings_user.display_name %>" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
    </div>
    <div class="pulse-user-info">
      <h1 class="pulse-user-name"><%= @settings_user.display_name %></h1>
      <p class="pulse-user-handle">@<%= @settings_user.handle %></p>
      <% if @settings_user.ai_agent? %>
        <span class="pulse-badge" title="This is a ai_agent managed by <%= @settings_user.parent&.display_name %>">ai_agent</span>
      <% end %>
    </div>
    <div class="pulse-user-actions">
      <a href="<%= @settings_user.path %>" class="pulse-action-btn">
        <%= octicon 'person', height: 14 %>
        View Profile
      </a>
    </div>
  </header>

  <%# Profile Section %>
  <%= render 'shared/pulse_accordion', title: 'Profile', open: true do %>
    <%# Profile image upload has its own form so must be outside the main profile form %>
    <div class="pulse-form-section">
      <label class="pulse-form-label">Profile Image</label>
      <p class="pulse-form-hint">Click the image to upload a new one</p>
      <%= render 'shared/profile_image_upload', resource: @settings_user, size: 64 %>
    </div>

    <%= form_with url: "#{@settings_user.path}/settings/profile", class: 'pulse-form' do |form| %>
      <div class="pulse-form-section">
        <label class="pulse-form-label" for="name">Display Name</label>
        <%= form.text_field :name, value: @settings_user.name, placeholder: 'Your name', class: 'pulse-input' %>
      </div>

      <div class="pulse-form-section">
        <label class="pulse-form-label" for="new_handle">Handle</label>
        <div class="pulse-input-prefix-wrapper">
          <span class="pulse-input-prefix">@</span>
          <%= form.text_field :new_handle, value: @settings_user.handle, placeholder: 'handle', class: 'pulse-input pulse-input-with-prefix' %>
        </div>
        <p class="pulse-form-hint">This is your unique identifier used in URLs and mentions</p>
      </div>

      <% if @settings_user.ai_agent? %>
        <% current_mode = @settings_user.agent_configuration&.dig("mode") || "external" %>
        <div data-controller="ai_agent-mode">
          <div class="pulse-form-section">
            <label class="pulse-form-label">Mode</label>
            <p class="pulse-form-hint" style="margin-bottom: 12px;">Choose how this ai_agent is powered.</p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="pulse-radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <%= radio_button_tag :mode, "internal", current_mode == "internal", data: { action: "ai_agent-mode#updateVisibility" } %>
                <span>
                  <strong>Internal</strong>
                  <span class="pulse-form-hint" style="display: block; margin-top: 2px;">Powered by Harmonic's agent runners. No API access.</span>
                </span>
              </label>
              <label class="pulse-radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <%= radio_button_tag :mode, "external", current_mode == "external", data: { action: "ai_agent-mode#updateVisibility" } %>
                <span>
                  <strong>External</strong>
                  <span class="pulse-form-hint" style="display: block; margin-top: 2px;">Powered by your own infrastructure through the API. Agent skill documents and MCP server are available.</span>
                </span>
              </label>
            </div>
          </div>

          <div class="pulse-form-section" data-ai_agent-mode-target="internalOnly" style="<%= current_mode == 'internal' ? '' : 'display: none;' %>">
            <label class="pulse-form-label" for="model">Model</label>
            <%= form.select :model, available_llm_models, { selected: @settings_user.agent_configuration&.dig("model") || "default" }, class: 'pulse-select' %>
            <p class="pulse-form-hint">The LLM model this ai_agent will use for reasoning.</p>
          </div>
        </div>

        <div class="pulse-form-section">
          <label class="pulse-form-label" for="identity_prompt">Identity Prompt</label>
          <%= form.text_area :identity_prompt, value: @settings_user.agent_configuration&.dig("identity_prompt"), placeholder: 'You are a helpful assistant...', class: 'pulse-textarea', rows: 4 %>
          <p class="pulse-form-hint">This prompt will be shown to the agent on the /whoami page, providing context about their identity and purpose.</p>
        </div>

        <div class="pulse-form-section">
          <label class="pulse-form-label">Capabilities</label>
          <p class="pulse-form-hint">
            Check the actions this agent is allowed to perform. Unchecked actions will be blocked.
          </p>

          <% current_caps = @settings_user.agent_configuration&.dig("capabilities") %>
          <% caps_not_configured = current_caps.nil? %>

          <%
            # Group actions by resource type
            action_groups = {
              "Always Allowed" => CapabilityCheck::AI_AGENT_ALWAYS_ALLOWED,
              "Notes" => %w[create_note update_note confirm_read],
              "Decisions" => %w[create_decision update_decision_settings vote add_options],
              "Commitments" => %w[create_commitment update_commitment_settings join_commitment],
              "Comments" => %w[add_comment],
              "Pins" => %w[pin_note unpin_note pin_decision unpin_decision pin_commitment unpin_commitment],
              "Attachments" => %w[add_attachment remove_attachment],
              "Reminders" => %w[create_reminder delete_reminder],
              "Trustee Grant Responses" => %w[accept_trustee_grant decline_trustee_grant],
              "Trustee Grant Admin" => %w[create_trustee_grant revoke_trustee_grant],
            }
            # Groups that are disabled by default for new agents
            disabled_by_default = %w[Attachments Reminders Trustee\ Grant\ Admin]
          %>

          <% action_groups.each do |group_name, actions| %>
            <% is_always_allowed = group_name == "Always Allowed" %>
            <div style="margin-top: 16px;" data-controller="<%= 'checkbox-group' unless is_always_allowed %>">
              <div style="font-weight: 500; font-size: 13px; margin-bottom: 8px; color: <%= is_always_allowed ? 'var(--text-muted)' : 'var(--text-primary)' %>; display: flex; align-items: center; gap: 12px;">
                <span><%= group_name %></span>
                <% if is_always_allowed %>
                  <span style="font-weight: normal; font-size: 12px;">(cannot be disabled)</span>
                <% else %>
                  <span style="font-weight: normal; font-size: 12px;">
                    <a href="#" data-action="checkbox-group#checkAll" class="pulse-link">all</a>
                    /
                    <a href="#" data-action="checkbox-group#uncheckAll" class="pulse-link">none</a>
                  </span>
                <% end %>
              </div>
              <div class="pulse-checkbox-group" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">
                <% actions.each do |action| %>
                  <% if is_always_allowed %>
                    <label class="pulse-checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: not-allowed; opacity: 0.6;">
                      <%= check_box_tag nil, action, true, disabled: true, id: "cap_#{action}" %>
                      <code style="font-size: 12px;"><%= action %></code>
                    </label>
                  <% else %>
                    <% checked = caps_not_configured ? !disabled_by_default.include?(group_name) : current_caps&.include?(action) %>
                    <label class="pulse-checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <%= check_box_tag "capabilities[]", action, checked, id: "cap_#{action}", data: { checkbox_group_target: "checkbox" } %>
                      <code style="font-size: 12px;"><%= action %></code>
                    </label>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <div class="pulse-form-actions">
        <%= form.submit 'Save Changes', class: 'pulse-action-btn-primary' %>
      </div>
    <% end %>
  <% end %>

  <% if is_own_settings %>
    <% if @settings_user.external_oauth_identities.any? %>
      <%# Connected Accounts Section %>
      <%= render 'shared/pulse_accordion', title: 'Connected Accounts', count: @settings_user.external_oauth_identities.count do %>
        <div class="pulse-connected-accounts-list">
          <% @settings_user.external_oauth_identities.each do |identity| %>
            <div class="pulse-connected-account-item">
              <div class="pulse-connected-account-info">
                <span class="pulse-connected-account-provider"><%= identity.provider.titleize %></span>
                <a href="<%= identity.url %>" class="pulse-connected-account-username">@<%= identity.username %></a>
              </div>
              <span class="pulse-connected-account-date">Connected <%= time_ago_in_words(identity.created_at) %> ago</span>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <% # Two-Factor Authentication Section (only for identity provider users) %>
    <% identity_for_2fa = OmniAuthIdentity.find_by(email: @settings_user.email) %>
    <% if identity_for_2fa %>
      <%= render 'shared/pulse_accordion', title: 'Two-Factor Authentication' do %>
        <p class="pulse-form-hint" style="margin-bottom:16px;">
          Add an extra layer of security to your account by requiring a verification code in addition to your password.
        </p>
        <% if identity_for_2fa.otp_enabled %>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <span class="pulse-badge pulse-badge-success">Enabled</span>
            <span class="pulse-form-hint">since <%= identity_for_2fa.otp_enabled_at.strftime('%B %d, %Y') %></span>
          </div>
          <p class="pulse-form-hint" style="margin-bottom:16px;">
            You have <strong><%= identity_for_2fa.remaining_recovery_codes_count %></strong> recovery codes remaining.
          </p>
          <div class="pulse-form-actions">
            <a href="<%= two_factor_settings_path %>" class="pulse-action-btn">
              <%= octicon 'shield-lock', height: 14 %>
              Manage 2FA
            </a>
          </div>
        <% else %>
          <div class="pulse-form-actions">
            <a href="<%= two_factor_setup_path %>" class="pulse-action-btn">
              <%= octicon 'shield-lock', height: 14 %>
              Enable Two-Factor Authentication
            </a>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <% if @current_tenant.api_enabled? %>
    <%# API Tokens Section %>
    <%= render 'shared/pulse_accordion', title: 'API Tokens', count: @settings_user.api_tokens.external.count do %>
      <p class="pulse-form-hint" style="margin-bottom:16px;">
        API tokens authenticate requests to the API. Actions taken through the API using these tokens are attributed to <%= @settings_user.name %>.
      </p>
      <% if @settings_user.api_tokens.external.any? %>
        <div class="pulse-table-wrapper">
          <table class="pulse-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Token</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Expires</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @settings_user.api_tokens.external.each do |token| %>
                <tr>
                  <td><%= token.name || 'Unnamed' %></td>
                  <td>
                    <code class="pulse-code"><%= token.obfuscated_token %></code>
                    <% if token.plaintext_token.present? %>
                      <%= render 'shared/copy_button', text: token.plaintext_token %>
                    <% end %>
                  </td>
                  <td><%= timeago(token.created_at) %></td>
                  <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                  <td><%= timeago(token.expires_at) %></td>
                  <td>
                    <% if token.active? %>
                      <span class="pulse-badge pulse-badge-success">Active</span>
                    <% else %>
                      <span class="pulse-badge pulse-badge-muted">Inactive</span>
                    <% end %>
                  </td>
                  <td><a href="<%= token.path %>" class="pulse-link">View</a></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
      <% if @current_user.human? %>
        <div class="pulse-form-actions" style="margin-top:16px;">
          <a href="<%= @settings_user.path %>/settings/tokens/new" class="pulse-action-btn">
            <%= octicon 'key', height: 14 %>
            Create API Token
          </a>
        </div>
      <% end %>
    <% end %>

    <%# Webhooks Section %>
    <%= render 'shared/pulse_accordion', title: 'Webhooks' do %>
      <p class="pulse-form-hint" style="margin-bottom:16px;">
        Webhooks allow you to receive notifications at an external URL when events occur.
      </p>
      <div class="pulse-form-actions">
        <a href="<%= @settings_user.path %>/settings/webhooks" class="pulse-action-btn">
          <%= octicon 'webhook', height: 14 %>
          Manage Webhooks
        </a>
      </div>
    <% end %>

    <%# Trustee Grants Section %>
    <% pending_count = @settings_user.pending_trustee_grant_requests.count %>
    <%= render 'shared/pulse_accordion', title: 'Trustee Grants', count: pending_count > 0 ? pending_count : nil do %>
      <p class="pulse-form-hint" style="margin-bottom:16px;">
        Manage who can act on your behalf and whose behalf you can act on.
      </p>
      <% if pending_count > 0 %>
        <div style="margin-bottom:16px;">
          <span class="pulse-badge pulse-badge-warning">
            <%= pluralize(pending_count, 'pending request') %>
          </span>
        </div>
      <% end %>
      <div class="pulse-form-actions">
        <a href="<%= @settings_user.path %>/settings/trustee-grants" class="pulse-action-btn">
          <%= octicon 'people', height: 14 %>
          Manage Trustee Grants
        </a>
      </div>
    <% end %>

    <% if @settings_user.human? && is_own_settings %>
      <%# AI Agents Section %>
      <%= render 'shared/pulse_accordion', title: 'AI Agents', count: @ai_agents.count do %>
        <p class="pulse-form-hint" style="margin-bottom:16px;">
          AI Agents are virtual identities that you manage. These identities can be associated with AI agents and other automated systems that interact with the app through the API.
        </p>

        <% if @ai_agents.any? %>
          <div class="pulse-ai-agents-list">
            <% @ai_agents.each do |ai_agent| %>
              <% active_superagent_members = ai_agent.superagent_members.reject(&:archived?) %>
              <% all_ai_agent_studios = active_superagent_members.map(&:superagent) %>
              <% ai_agent_studios = all_ai_agent_studios.reject { |s| s == @current_tenant.main_superagent } %>
              <% available_studios = (@invitable_studios - all_ai_agent_studios).reject { |s| s == @current_tenant.main_superagent } %>

              <div class="pulse-ai-agent-card" data-controller="ai-agent-superagent-adder" data-ai-agent-superagent-adder-remove-url-value="<%= ai_agent.path %>/remove_from_studio">
                <div class="pulse-ai-agent-header">
                  <img src="<%= ai_agent.image_url %>" alt="<%= ai_agent.name %>" class="pulse-ai-agent-avatar">
                  <div class="pulse-ai-agent-info">
                    <div class="pulse-ai-agent-name">
                      <a href="<%= ai_agent.path %>"><%= ai_agent.name %></a>
                      <% if ai_agent.archived? %>
                        <span class="pulse-badge pulse-badge-muted">Archived</span>
                      <% end %>
                    </div>
                    <span class="pulse-ai-agent-meta">Created <%= timeago(ai_agent.created_at) %></span>
                  </div>
                  <div class="pulse-ai-agent-actions">
                    <% unless ai_agent.archived? %>
                      <%= button_to 'Represent', "#{ai_agent.path}/represent", method: :post, class: 'pulse-action-btn-small' %>
                    <% end %>
                    <a href="<%= ai_agent.path %>/settings" class="pulse-action-btn-small">Settings</a>
                  </div>
                </div>

                <div class="pulse-ai-agent-studios">
                  <label class="pulse-form-label">Studio Memberships</label>
                  <ul class="pulse-studio-membership-list" data-ai-agent-superagent-adder-target="superagentList">
                    <% if ai_agent_studios.any? %>
                      <% ai_agent_studios.each do |s| %>
                        <li class="pulse-studio-membership-item" data-superagent-id="<%= s.id %>">
                          <a href="<%= s.path %>"><%= s.name %></a>
                          <button type="button" class="pulse-action-btn-small pulse-action-btn-danger"
                                  data-action="ai-agent-superagent-adder#remove"
                                  data-superagent-id="<%= s.id %>"
                                  data-superagent-name="<%= s.name %>">
                            Remove
                          </button>
                        </li>
                      <% end %>
                    <% else %>
                      <li class="pulse-studio-membership-empty"><em>Not a member of any studios</em></li>
                    <% end %>
                  </ul>

                  <% if !ai_agent.archived? && available_studios.any? %>
                    <form data-ai-agent-superagent-adder-target="form" data-action="submit->ai-agent-superagent-adder#add" action="<%= ai_agent.path %>/add_to_studio" method="post" class="pulse-add-studio-form">
                      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                      <select name="superagent_id" data-ai-agent-superagent-adder-target="select" class="pulse-select">
                        <option value="">Add to studio...</option>
                        <% available_studios.each do |s| %>
                          <option value="<%= s.id %>"><%= s.name %></option>
                        <% end %>
                      </select>
                      <button type="submit" class="pulse-action-btn-small">Add</button>
                    </form>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="pulse-form-actions" style="margin-top:16px;">
          <a href="<%= @settings_user.path %>/settings/ai-agents/new" class="pulse-action-btn">
            <%= octicon 'person-add', height: 14 %>
            Create AI Agent
          </a>
        </div>
      <% end %>

      <% if @ai_agents.any? %>
        <%# AI Agent API Tokens Section %>
        <%= render 'shared/pulse_accordion', title: 'AI Agent API Tokens' do %>
          <p class="pulse-form-hint" style="margin-bottom:16px;">
            AI Agents have their own API tokens, which you as the owner are responsible for.
          </p>

          <% @ai_agents.each do |ai_agent| %>
            <div class="pulse-ai-agent-tokens-section">
              <h4 class="pulse-subsection-title"><%= ai_agent.name %></h4>
              <% if ai_agent.api_tokens.external.any? %>
                <div class="pulse-table-wrapper">
                  <table class="pulse-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Token</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th>Expires</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% ai_agent.api_tokens.external.each do |token| %>
                        <tr>
                          <td><%= token.name || 'Unnamed' %></td>
                          <td>
                            <code class="pulse-code"><%= token.obfuscated_token %></code>
                            <% if token.plaintext_token.present? %>
                              <%= render 'shared/copy_button', text: token.plaintext_token %>
                            <% end %>
                          </td>
                          <td><%= timeago(token.created_at) %></td>
                          <td><%= token.last_used_at ? timeago(token.last_used_at) : 'Never' %></td>
                          <td><%= timeago(token.expires_at) %></td>
                          <td>
                            <% if token.active? %>
                              <span class="pulse-badge pulse-badge-success">Active</span>
                            <% else %>
                              <span class="pulse-badge pulse-badge-muted">Inactive</span>
                            <% end %>
                          </td>
                          <td><a href="<%= token.path %>" class="pulse-link">View</a></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <p class="pulse-form-hint"><%= ai_agent.name %> has no API tokens.</p>
              <% end %>
              <% if ai_agent.external_ai_agent? %>
                <div class="pulse-form-actions" style="margin-top:12px;">
                  <a href="<%= ai_agent.path %>/settings/tokens/new" class="pulse-action-btn-small">
                    <%= octicon 'key', height: 12 %>
                    Create Token
                  </a>
                </div>
              <% else %>
                <p class="pulse-form-hint" style="margin-top:12px; font-style: italic;">Internal ai_agents cannot have API tokens.</p>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</article>
