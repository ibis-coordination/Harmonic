<%= render 'shared/pulse_breadcrumb', items: [
  [@current_superagent.name, @current_superagent.path],
  ['Representation', @current_superagent.path + '/representation'],
  "Session #{@representation_session.truncated_id}"
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'person', height: 14, class: 'pulse-resource-icon' %>
        Representation Session
      </span>
      <div class="pulse-resource-actions">
        <%= render 'shared/copy_to_clipboard', text: request.original_url %>
      </div>
    </div>
    <h1 class="pulse-resource-title">Session <%= @representation_session.truncated_id %></h1>
  </header>

  <div class="pulse-resource-meta">
    <%= profile_pic(@representation_session.representative_user, size: 20) %>
    <a href="<%= @representation_session.representative_user.path %>" class="pulse-link"><%= @representation_session.representative_user.display_name %></a>
    <span class="pulse-muted">started <%= timeago(@representation_session.began_at) %></span>
    <% if @representation_session.ended_at %>
      <span class="pulse-muted">ended <%= timeago(@representation_session.ended_at) %></span>
      <% duration = (@representation_session.elapsed_time / 60).round %>
      <span class="pulse-muted">(<%= duration %> minute<%= duration == 1 ? '' : 's' %>)</span>
    <% end %>
  </div>

  <div class="pulse-resource-body">
    <% unless @representation_session.ended_at %>
      <div class="pulse-notice pulse-notice-info">
        <p>This session is currently active.</p>
        <% if @representation_session.representative_user == @current_user %>
          <%= button_to 'End Session', @representation_session.path, method: :delete, class: 'pulse-action-btn pulse-action-btn-danger' %>
        <% end %>
      </div>
    <% end %>

    <%= render 'shared/pulse_accordion', title: 'Actions', open: true, count: @representation_session.human_readable_activity_log.length do %>
      <% if @representation_session.human_readable_activity_log.empty? %>
        <p class="pulse-empty-content"><em>No actions were performed during this session.</em></p>
      <% else %>
        <p>
          <%= @representation_session.representative_user.display_name %> performed the following actions on behalf of <%= @representation_session.superagent.name %>:
        </p>
        <table class="pulse-table">
          <thead>
            <tr>
              <th></th>
              <th>Time</th>
              <th>Action</th>
              <th>Item</th>
              <th>Studio</th>
            </tr>
          </thead>
          <tbody>
            <% @representation_session.human_readable_activity_log.each.with_index do |activity_item, i| %>
              <tr>
                <td><%= i + 1 %></td>
                <td><%= activity_item[:happened_at].to_time.in_time_zone(@current_superagent.timezone.name).strftime('%H:%M %Z') %></td>
                <td><%= activity_item[:verb_phrase] %></td>
                <td>
                  <a href="<%= activity_item[:main_resource].path %>" class="pulse-link">
                    <%= activity_item[:main_resource].class.to_s %>
                    <code><%= activity_item[:main_resource].truncated_id %></code>
                  </a>
                </td>
                <td><a href="<%= activity_item[:studio].path %>" class="pulse-link"><%= activity_item[:studio].name %></a></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>

    <%= render 'shared/pulse_comments', commentable: @representation_session %>
    <%= render 'shared/pulse_backlinks', resource: @representation_session %>
  </div>
</article>
