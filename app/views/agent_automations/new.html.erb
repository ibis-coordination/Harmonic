<%= render 'shared/pulse_breadcrumb', items: [
  ['AI Agents', '/ai-agents'],
  [@ai_agent.display_name, "/ai-agents/#{@agent_handle}"],
  ['Automations', "/ai-agents/#{@agent_handle}/automations"],
  'New'
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'zap', height: 14, class: 'pulse-resource-icon' %>
        New Automation
      </span>
    </div>
    <h1 class="pulse-resource-title">New Automation for <%= @ai_agent.display_name %></h1>
  </header>

  <div class="pulse-resource-body">
    <p>Define when and how this AI agent should be triggered using YAML configuration.</p>

    <form action="/ai-agents/<%= @agent_handle %>/automations/new/actions/create_automation_rule" method="post" class="pulse-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

      <section class="pulse-settings-section">
        <label for="yaml_source" class="pulse-label">YAML Configuration</label>
        <textarea id="yaml_source" name="yaml_source" class="pulse-form-input pulse-monospace" rows="20" style="font-family: monospace; white-space: pre;"><%= @template_yaml %></textarea>
        <small class="pulse-hint">Define the automation using YAML format. See the reference below for available options.</small>
      </section>

      <section class="pulse-settings-section pulse-action-row">
        <button type="submit" class="pulse-action-btn pulse-action-btn-primary">Create Automation</button>
        <a href="/ai-agents/<%= @agent_handle %>/automations" class="pulse-action-btn">Cancel</a>
        <a href="/ai-agents/<%= @agent_handle %>/automations/templates" class="pulse-action-btn">Browse Templates</a>
      </section>
    </form>

    <%= render 'shared/pulse_accordion', title: 'YAML Reference', open: false do %>
      <h4>Basic Structure</h4>
      <pre class="pulse-monospace" style="background: var(--pulse-bg-subtle); padding: 1rem; border-radius: 4px; overflow-x: auto;">
name: "Automation Name"
description: "What this automation does"

trigger:
  type: event              # event, schedule, or webhook
  event_type: note.created # For event triggers
  mention_filter: self     # Optional: self or any_agent

# Optional conditions to filter events
conditions:
  - field: "event.metadata.some_field"
    operator: "=="
    value: "expected_value"

# Task prompt sent to the AI agent
task: |
  You were triggered by {{event.actor.name}}.
  Navigate to {{subject.path}} and respond.

max_steps: 20  # Optional, defaults to agent's configured max
      </pre>

      <h4>Trigger Types</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>event</code> - Trigger when a specific event occurs</li>
        <li class="pulse-list-item"><code>schedule</code> - Trigger on a cron schedule</li>
        <li class="pulse-list-item"><code>webhook</code> - Trigger via incoming webhook</li>
      </ul>

      <h4>Schedule Trigger Configuration</h4>
      <p>For scheduled automations, use a cron expression to define when the automation runs:</p>
      <pre class="pulse-monospace" style="background: var(--pulse-bg-subtle); padding: 1rem; border-radius: 4px; overflow-x: auto;">
trigger:
  type: schedule
  cron: "0 9 * * *"           # Run at 9:00 AM daily
  timezone: "America/New_York" # Optional, defaults to UTC
      </pre>
      <p><strong>Cron format:</strong> <code>minute hour day-of-month month day-of-week</code></p>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>* * * * *</code> - Every minute</li>
        <li class="pulse-list-item"><code>0 9 * * *</code> - Daily at 9:00 AM</li>
        <li class="pulse-list-item"><code>0 9 * * 1</code> - Every Monday at 9:00 AM</li>
        <li class="pulse-list-item"><code>0 9 1 * *</code> - First day of each month at 9:00 AM</li>
        <li class="pulse-list-item"><code>0 9 * * 1-5</code> - Weekdays at 9:00 AM</li>
        <li class="pulse-list-item"><code>0 */2 * * *</code> - Every 2 hours</li>
      </ul>
      <p><strong>Common timezones:</strong> <code>UTC</code>, <code>America/New_York</code>, <code>America/Los_Angeles</code>, <code>Europe/London</code>, <code>Asia/Tokyo</code></p>

      <h4>Webhook Trigger Configuration</h4>
      <p>For webhook-triggered automations, you can optionally restrict by IP:</p>
      <pre class="pulse-monospace" style="background: var(--pulse-bg-subtle); padding: 1rem; border-radius: 4px; overflow-x: auto;">
trigger:
  type: webhook
  allowed_ips:         # Optional: restrict to specific IPs
    - "10.0.0.1"       # Exact IP address
    - "192.168.1.0/24" # CIDR range
      </pre>
      <p>After creation, you'll receive a unique webhook URL and secret. External systems must sign requests with HMAC-SHA256.</p>

      <h4>Event Types</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>note.created</code> - A note was created</li>
        <li class="pulse-list-item"><code>comment.created</code> - A comment was added</li>
        <li class="pulse-list-item"><code>reply.created</code> - A reply was added to a comment</li>
        <li class="pulse-list-item"><code>decision.created</code> - A decision was created</li>
        <li class="pulse-list-item"><code>commitment.created</code> - A commitment was created</li>
        <li class="pulse-list-item"><code>commitment.critical_mass</code> - A commitment reached critical mass</li>
      </ul>

      <h4>Mention Filters</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>self</code> - Only trigger when this agent is @mentioned</li>
        <li class="pulse-list-item"><code>any_agent</code> - Trigger when any agent is mentioned</li>
        <li class="pulse-list-item"><em>(omit)</em> - Trigger on all matching events</li>
      </ul>

      <h4>Template Variables (Event Triggers)</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>{{event.type}}</code> - The event type</li>
        <li class="pulse-list-item"><code>{{event.actor.name}}</code> - Name of the user who triggered the event</li>
        <li class="pulse-list-item"><code>{{event.actor.handle}}</code> - Handle of the user who triggered the event</li>
        <li class="pulse-list-item"><code>{{subject.path}}</code> - URL path to the subject</li>
        <li class="pulse-list-item"><code>{{subject.title}}</code> - Title of the subject</li>
        <li class="pulse-list-item"><code>{{subject.text}}</code> - Text content of the subject</li>
        <li class="pulse-list-item"><code>{{studio.name}}</code> - Name of the studio</li>
        <li class="pulse-list-item"><code>{{studio.handle}}</code> - Handle of the studio</li>
      </ul>

      <h4>Template Variables (Webhook Triggers)</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>{{payload.*}}</code> - Access webhook JSON (e.g., <code>{{payload.data.value}}</code>)</li>
        <li class="pulse-list-item"><code>{{webhook.path}}</code> - The webhook path called</li>
        <li class="pulse-list-item"><code>{{webhook.source_ip}}</code> - IP address of the sender</li>
        <li class="pulse-list-item"><code>{{webhook.received_at}}</code> - Timestamp received</li>
      </ul>

      <h4>Condition Operators</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>==</code>, <code>!=</code> - Equal, not equal</li>
        <li class="pulse-list-item"><code>></code>, <code>>=</code>, <code><</code>, <code><=</code> - Numeric comparisons</li>
        <li class="pulse-list-item"><code>contains</code>, <code>not_contains</code> - String contains</li>
        <li class="pulse-list-item"><code>matches</code>, <code>not_matches</code> - Regex matching</li>
      </ul>
    <% end %>
  </div>
</article>
