<%= render 'shared/pulse_breadcrumb', items: [
  ['AI Agents', '/ai-agents'],
  [@ai_agent.display_name, "/ai-agents/#{@agent_handle}"],
  ['Automations', "/ai-agents/#{@agent_handle}/automations"],
  [@automation_rule.name, "/ai-agents/#{@agent_handle}/automations/#{@automation_rule.truncated_id}"],
  'Run History'
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'history', height: 14, class: 'pulse-resource-icon' %>
        Run History
      </span>
    </div>
    <h1 class="pulse-resource-title">Run History: <%= @automation_rule.name %></h1>
  </header>

  <div class="pulse-resource-body">
    <p class="pulse-action-row">
      <a href="/ai-agents/<%= @agent_handle %>/automations/<%= @automation_rule.truncated_id %>" class="pulse-action-btn">
        <%= octicon "arrow-left" %> Back to Automation
      </a>
    </p>

    <% if @runs.empty? %>
      <p class="pulse-empty-content"><em>No runs recorded yet.</em></p>
      <p>Runs will appear here once this automation is triggered.</p>
    <% else %>
      <table class="pulse-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Status</th>
            <th>Trigger</th>
            <th>Duration</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <% @runs.each do |run| %>
            <tr>
              <td>
                <%= run.created_at.strftime('%Y-%m-%d %H:%M:%S') %>
                <br><small class="pulse-hint"><%= time_ago_in_words(run.created_at) %> ago</small>
              </td>
              <td>
                <% case run.status %>
                <% when 'completed' %>
                  <span class="pulse-tag pulse-tag-success">Completed</span>
                <% when 'failed' %>
                  <span class="pulse-tag pulse-tag-danger">Failed</span>
                <% when 'running' %>
                  <span class="pulse-tag pulse-tag-info">Running</span>
                <% when 'pending' %>
                  <span class="pulse-tag">Pending</span>
                <% when 'skipped' %>
                  <span class="pulse-tag">Skipped</span>
                <% else %>
                  <span class="pulse-tag"><%= run.status %></span>
                <% end %>
              </td>
              <td><%= run.trigger_source %></td>
              <td>
                <% if run.started_at && run.completed_at %>
                  <%= distance_of_time_in_words(run.started_at, run.completed_at) %>
                <% elsif run.started_at %>
                  <em>In progress...</em>
                <% else %>
                  <em>Not started</em>
                <% end %>
              </td>
              <td>
                <% if run.error_message.present? %>
                  <span class="pulse-hint" title="<%= run.error_message %>">
                    <%= octicon "alert" %> <%= truncate(run.error_message, length: 40) %>
                  </span>
                <% elsif run.ai_agent_task_run.present? %>
                  <a href="/ai-agents/<%= @agent_handle %>/runs/<%= run.ai_agent_task_run_id %>" class="pulse-link">
                    View Task Run
                  </a>
                <% elsif run.actions_executed.present? && run.actions_executed.any? %>
                  <%= run.actions_executed.size %> action(s)
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</article>
