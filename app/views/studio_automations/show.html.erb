<%= render 'shared/pulse_breadcrumb', items: [
  [@current_superagent.name, @current_superagent.path],
  ['Settings', @current_superagent.path + '/settings'],
  ['Automations', automations_index_path],
  @automation_rule.name
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'zap', height: 14, class: 'pulse-resource-icon' %>
        Automation
      </span>
    </div>
    <h1 class="pulse-resource-title"><%= @automation_rule.name %></h1>
    <% if @automation_rule.description.present? %>
      <p class="pulse-resource-description"><%= @automation_rule.description %></p>
    <% end %>
  </header>

  <div class="pulse-resource-body">
    <section class="pulse-settings-section">
      <table class="pulse-table">
        <tr>
          <th style="width:140px;">Status</th>
          <td>
            <% if @automation_rule.enabled? %>
              <span class="pulse-tag pulse-tag-success">Enabled</span>
            <% else %>
              <span class="pulse-tag">Disabled</span>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Trigger Type</th>
          <td><span class="pulse-tag"><%= @automation_rule.trigger_type %></span></td>
        </tr>
        <% if @automation_rule.trigger_type == 'event' %>
          <tr>
            <th>Event Type</th>
            <td><code><%= @automation_rule.event_type %></code></td>
          </tr>
        <% elsif @automation_rule.trigger_type == 'schedule' %>
          <tr>
            <th>Cron Expression</th>
            <td><code><%= @automation_rule.cron_expression %></code></td>
          </tr>
          <tr>
            <th>Timezone</th>
            <td><%= @automation_rule.timezone %></td>
          </tr>
          <% if @automation_rule.next_scheduled_run %>
            <tr>
              <th>Next Run</th>
              <td><%= @automation_rule.next_scheduled_run.strftime('%Y-%m-%d %H:%M %Z') %></td>
            </tr>
          <% end %>
        <% elsif @automation_rule.trigger_type == 'webhook' %>
          <%
            protocol = ENV['HOSTNAME'].to_s.include?('localhost') ? 'http' : 'https'
            webhook_url = "#{protocol}://#{@current_tenant.subdomain}.#{ENV['HOSTNAME']}/hooks/#{@automation_rule.webhook_path}"
          %>
          <tr>
            <th>Webhook URL</th>
            <td>
              <code class="pulse-monospace" style="word-break:break-all;"><%= webhook_url %></code>
              <span data-controller="clipboard" style="margin-left: 0.5rem;">
                <input type="text" value="<%= webhook_url %>" data-clipboard-target="source" style="display:none;"/>
                <button type="button" class="pulse-action-btn pulse-action-btn-small" data-action="click->clipboard#copy">
                  <span data-clipboard-target="button"><%= octicon 'copy', height: 12 %> Copy</span>
                  <span data-clipboard-target="successMessage" style="display:none;"><%= octicon 'check', height: 12 %> Copied!</span>
                </button>
              </span>
            </td>
          </tr>
          <tr>
            <th>Secret</th>
            <td data-controller="secret-reveal clipboard">
              <input type="text" value="<%= @automation_rule.webhook_secret %>" data-clipboard-target="source" style="display:none;"/>
              <code class="pulse-monospace" style="font-family: monospace; letter-spacing: 0;">
                <span data-secret-reveal-target="hidden">●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●</span>
                <span data-secret-reveal-target="visible" style="display:none;"><%= @automation_rule.webhook_secret %></span>
              </code>
              <button type="button" class="pulse-action-btn pulse-action-btn-small" data-action="click->clipboard#copy">
                <span data-clipboard-target="button"><%= octicon 'copy', height: 12 %> Copy</span>
                <span data-clipboard-target="successMessage" style="display:none;"><%= octicon 'check', height: 12 %> Copied!</span>
              </button>
              <button type="button" class="pulse-action-btn pulse-action-btn-small" data-action="click->secret-reveal#reveal" data-secret-reveal-target="hidden">
                <%= octicon 'eye', height: 12 %> Reveal
              </button>
              <button type="button" class="pulse-action-btn pulse-action-btn-small" data-action="click->secret-reveal#hide" data-secret-reveal-target="visible" style="display:none;">
                <%= octicon 'eye-closed', height: 12 %> Hide
              </button>
            </td>
          </tr>
          <tr>
            <th>Allowed IPs</th>
            <td>
              <% if @automation_rule.ip_restricted? %>
                <% @automation_rule.allowed_ips.each do |ip| %>
                  <code class="pulse-monospace"><%= ip %></code><br/>
                <% end %>
              <% else %>
                <em>All IPs allowed</em>
              <% end %>
            </td>
          </tr>
        <% elsif @automation_rule.trigger_type == 'manual' %>
          <% if @automation_rule.manual_inputs.any? %>
            <tr>
              <th>Inputs</th>
              <td>
                <% @automation_rule.manual_inputs.each do |name, definition| %>
                  <div style="margin-bottom: 0.5rem;">
                    <strong><%= definition['label'] || name.humanize %></strong>
                    (<code><%= name %></code>)
                    <% if definition['type'] %>
                      - <%= definition['type'] %>
                    <% end %>
                    <% if definition['default'] %>
                      <br/><em>Default: <%= definition['default'] %></em>
                    <% end %>
                  </div>
                <% end %>
              </td>
            </tr>
          <% else %>
            <tr>
              <th>Inputs</th>
              <td><em>No inputs defined</em></td>
            </tr>
          <% end %>
        <% end %>
        <tr>
          <th>Total Executions</th>
          <td><%= @automation_rule.execution_count %></td>
        </tr>
        <tr>
          <th>Last Executed</th>
          <td>
            <% if @automation_rule.last_executed_at %>
              <%= @automation_rule.last_executed_at.strftime('%Y-%m-%d %H:%M %Z') %>
              (<%= time_ago_in_words(@automation_rule.last_executed_at) %> ago)
            <% else %>
              <em>Never</em>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Created</th>
          <td>
            <%= @automation_rule.created_at.strftime('%Y-%m-%d %H:%M') %>
            by <strong><%= @automation_rule.created_by.display_name %></strong>
          </td>
        </tr>
        <% if @automation_rule.updated_by.present? %>
          <tr>
            <th>Last Updated</th>
            <td>
              <%= @automation_rule.updated_at.strftime('%Y-%m-%d %H:%M') %>
              by <strong><%= @automation_rule.updated_by.display_name %></strong>
            </td>
          </tr>
        <% end %>
      </table>
    </section>

    <% if @automation_rule.trigger_type == 'webhook' %>
      <%
        protocol = ENV['HOSTNAME'].to_s.include?('localhost') ? 'http' : 'https'
        webhook_url = "#{protocol}://#{@current_tenant.subdomain}.#{ENV['HOSTNAME']}/hooks/#{@automation_rule.webhook_path}"
      %>
      <%= render 'shared/pulse_accordion', title: 'How to Call This Webhook', open: false do %>
        <p>Send a POST request with HMAC signature authentication:</p>

        <h4>Required Headers</h4>
        <table class="pulse-table">
          <tr>
            <th style="width:180px;">X-Harmonic-Timestamp</th>
            <td>Unix timestamp (seconds since epoch). Must be within 5 minutes of current time.</td>
          </tr>
          <tr>
            <th>X-Harmonic-Signature</th>
            <td><code>sha256={signature}</code> where signature is HMAC-SHA256 of <code>{timestamp}.{body}</code> using the secret.</td>
          </tr>
        </table>

        <h4>Example (bash)</h4>
        <pre class="pulse-code-block"><code>#!/bin/bash
WEBHOOK_URL="<%= webhook_url %>"
SECRET="<%= @automation_rule.webhook_secret %>"
BODY='{"event":"test","data":{}}'
TIMESTAMP=$(date +%s)
SIGNATURE=$(echo -n "${TIMESTAMP}.${BODY}" | openssl dgst -sha256 -hmac "${SECRET}" | cut -d' ' -f2)

curl -X POST "${WEBHOOK_URL}" \
  -H "Content-Type: application/json" \
  -H "X-Harmonic-Timestamp: ${TIMESTAMP}" \
  -H "X-Harmonic-Signature: sha256=${SIGNATURE}" \
  -d "${BODY}"</code></pre>

        <h4>Example (Ruby)</h4>
        <pre class="pulse-code-block"><code>require 'net/http'
require 'openssl'
require 'json'

url = "<%= webhook_url %>"
secret = "<%= @automation_rule.webhook_secret %>"
body = { event: "test", data: {} }.to_json
timestamp = Time.now.to_i
signature = OpenSSL::HMAC.hexdigest('sha256', secret, "#{timestamp}.#{body}")

uri = URI(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == 'https'

request = Net::HTTP::Post.new(uri)
request['Content-Type'] = 'application/json'
request['X-Harmonic-Timestamp'] = timestamp.to_s
request['X-Harmonic-Signature'] = "sha256=#{signature}"
request.body = body

response = http.request(request)
puts response.body</code></pre>
      <% end %>
    <% end %>

    <section class="pulse-settings-section pulse-action-row">
      <a href="<%= automation_path(@automation_rule) %>/edit" class="pulse-action-btn pulse-action-btn-primary">
        <%= octicon "pencil" %> Edit
      </a>

      <% if @automation_rule.enabled? %>
        <form action="<%= automation_path(@automation_rule) %>/actions/toggle_automation_rule" method="post" style="display:inline;">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <button type="submit" class="pulse-action-btn">Disable</button>
        </form>
      <% else %>
        <form action="<%= automation_path(@automation_rule) %>/actions/toggle_automation_rule" method="post" style="display:inline;">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <button type="submit" class="pulse-action-btn pulse-action-btn-success">Enable</button>
        </form>
      <% end %>

      <form action="<%= automation_path(@automation_rule) %>/actions/test_automation_rule" method="post" style="display:inline;">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="pulse-action-btn">
          <%= octicon "beaker" %> Test
        </button>
      </form>

      <% if @automation_rule.manual_trigger? && @automation_rule.manual_inputs.empty? %>
        <form action="<%= automation_path(@automation_rule) %>/actions/run_automation_rule" method="post" style="display:inline;">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <button type="submit" class="pulse-action-btn pulse-action-btn-success">
            <%= octicon "play" %> Run
          </button>
        </form>
      <% end %>

      <form action="<%= automation_path(@automation_rule) %>/actions/delete_automation_rule" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this automation?');">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="pulse-action-btn pulse-action-btn-danger">Delete</button>
      </form>

      <a href="<%= automation_path(@automation_rule) %>/runs" class="pulse-action-btn">
        View Run History
      </a>
    </section>

    <% if @automation_rule.manual_trigger? && @automation_rule.manual_inputs.any? %>
      <section class="pulse-settings-section">
        <h3>Run Automation</h3>
        <p>Provide values for the inputs below, then click Run.</p>
        <form action="<%= automation_path(@automation_rule) %>/actions/run_automation_rule" method="post" class="pulse-form">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

          <% @automation_rule.manual_inputs.each do |name, definition| %>
            <div style="margin-bottom: 1rem;">
              <label for="inputs_<%= name %>" class="pulse-label">
                <%= definition['label'] || name.humanize %>
                <% if definition['type'] %>
                  <small class="pulse-muted">(<%= definition['type'] %>)</small>
                <% end %>
              </label>
              <% case definition['type'] %>
              <% when 'boolean' %>
                <select name="inputs[<%= name %>]" id="inputs_<%= name %>" class="pulse-form-input">
                  <option value="false" <%= 'selected' if definition['default'] == false %>>false</option>
                  <option value="true" <%= 'selected' if definition['default'] == true %>>true</option>
                </select>
              <% when 'number' %>
                <input type="number" step="any" name="inputs[<%= name %>]" id="inputs_<%= name %>"
                       value="<%= definition['default'] %>" class="pulse-form-input" />
              <% else %>
                <input type="text" name="inputs[<%= name %>]" id="inputs_<%= name %>"
                       value="<%= definition['default'] %>" class="pulse-form-input" />
              <% end %>
            </div>
          <% end %>

          <button type="submit" class="pulse-action-btn pulse-action-btn-success">
            <%= octicon "play" %> Run
          </button>
        </form>
      </section>
    <% end %>

    <% if @automation_rule.actions.is_a?(Array) && @automation_rule.actions.any? %>
      <%= render 'shared/pulse_accordion', title: 'Actions', open: true, count: @automation_rule.actions.size do %>
        <% @automation_rule.actions.each_with_index do |action, index| %>
          <div class="pulse-settings-section">
            <h4>Action <%= index + 1 %>: <%= action['type'] %></h4>
            <table class="pulse-table">
              <% case action['type'] %>
              <% when 'webhook' %>
                <tr>
                  <th style="width:100px;">URL</th>
                  <td><code><%= action['url'] %></code></td>
                </tr>
                <tr>
                  <th>Method</th>
                  <td><%= action['method'] || 'POST' %></td>
                </tr>
              <% when 'internal_action' %>
                <tr>
                  <th style="width:100px;">Action</th>
                  <td><code><%= action['action'] %></code></td>
                </tr>
              <% when 'trigger_agent' %>
                <tr>
                  <th style="width:100px;">Agent ID</th>
                  <td><code><%= action['agent_id'] %></code></td>
                </tr>
                <% if action['task'] %>
                  <tr>
                    <th>Task</th>
                    <td><%= action['task'] %></td>
                  </tr>
                <% end %>
              <% end %>
            </table>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <% if @recent_runs.any? %>
      <%= render 'shared/pulse_accordion', title: 'Recent Runs', open: true, count: @recent_runs.size do %>
        <table class="pulse-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Status</th>
              <th>Trigger</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_runs.each do |run| %>
              <tr>
                <td>
                  <a href="<%= automation_path(@automation_rule) %>/runs/<%= run.id %>">
                    <%= time_ago_in_words(run.created_at) %> ago
                  </a>
                </td>
                <td>
                  <% case run.status %>
                  <% when "completed" %>
                    <span class="pulse-tag pulse-tag-success">Completed</span>
                  <% when "failed" %>
                    <span class="pulse-tag pulse-tag-danger">Failed</span>
                  <% when "running" %>
                    <span class="pulse-tag pulse-tag-warning">Running</span>
                  <% else %>
                    <span class="pulse-tag">Pending</span>
                  <% end %>
                </td>
                <td><%= run.trigger_source %></td>
                <td>
                  <% if run.actions_executed.present? %>
                    <a href="<%= automation_path(@automation_rule) %>/runs/<%= run.id %>">
                      <%= run.actions_executed.size %> action(s)
                    </a>
                  <% elsif run.error_message.present? %>
                    <a href="<%= automation_path(@automation_rule) %>/runs/<%= run.id %>" class="pulse-error-text">
                      Error
                    </a>
                  <% else %>
                    -
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <p><a href="<%= automation_path(@automation_rule) %>/runs">View all runs</a></p>
      <% end %>
    <% end %>

    <% if @automation_rule.yaml_source.present? %>
      <%= render 'shared/pulse_accordion', title: 'YAML Configuration', open: false do %>
        <pre class="pulse-code-block"><code><%= @automation_rule.yaml_source %></code></pre>
      <% end %>
    <% end %>
  </div>
</article>
