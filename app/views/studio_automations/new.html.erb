<%= render 'shared/pulse_breadcrumb', items: [
  [@current_superagent.name, @current_superagent.path],
  ['Settings', @current_superagent.path + '/settings'],
  ['Automations', automations_index_path],
  'New'
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'zap', height: 14, class: 'pulse-resource-icon' %>
        New Automation
      </span>
    </div>
    <h1 class="pulse-resource-title">New Automation</h1>
  </header>

  <div class="pulse-resource-body">
    <p>Create a new automation by providing YAML configuration.</p>

    <form action="<%= automations_index_path %>/new/actions/create_automation_rule" method="post" class="pulse-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

      <section class="pulse-settings-section">
        <label for="yaml_source" class="pulse-label">YAML Configuration</label>
        <textarea id="yaml_source" name="yaml_source" class="pulse-form-input pulse-code-input" rows="20" style="font-family: monospace;"><%= @yaml_source %></textarea>
        <small class="pulse-hint">Define the automation trigger, conditions, and actions in YAML format.</small>
      </section>

      <section class="pulse-settings-section pulse-action-row">
        <button type="submit" class="pulse-action-btn pulse-action-btn-primary">Create Automation</button>
        <a href="<%= automations_index_path %>" class="pulse-action-btn">Cancel</a>
      </section>
    </form>

    <%= render 'shared/pulse_accordion', title: 'YAML Reference', open: false do %>
      <h4>Trigger Types</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>event</code> - Trigger when a specific event occurs</li>
        <li class="pulse-list-item"><code>schedule</code> - Trigger on a cron schedule</li>
        <li class="pulse-list-item"><code>webhook</code> - Trigger via incoming webhook (supports IP restrictions)</li>
      </ul>

      <h4>Event Types</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>note.created</code> - A note was created</li>
        <li class="pulse-list-item"><code>comment.created</code> - A comment was added</li>
        <li class="pulse-list-item"><code>decision.created</code> - A decision was created</li>
        <li class="pulse-list-item"><code>commitment.created</code> - A commitment was created</li>
        <li class="pulse-list-item"><code>commitment.critical_mass</code> - A commitment reached critical mass</li>
      </ul>

      <h4>Schedule Examples</h4>
      <table class="pulse-table">
        <thead>
          <tr>
            <th>Expression</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><code>0 9 * * *</code></td><td>Daily at 9:00 AM</td></tr>
          <tr><td><code>0 9 * * 1</code></td><td>Every Monday at 9:00 AM</td></tr>
          <tr><td><code>0 9 1 * *</code></td><td>First day of month at 9:00 AM</td></tr>
          <tr><td><code>0 */2 * * *</code></td><td>Every 2 hours</td></tr>
        </tbody>
      </table>

      <h4>Webhook Configuration</h4>
      <p>Webhook triggers support optional IP restrictions:</p>
      <pre class="pulse-code-block"><code>trigger:
  type: webhook
  allowed_ips:         # Optional
    - "10.0.0.1"       # Exact IP
    - "192.168.1.0/24" # CIDR range</code></pre>
      <p><small>If <code>allowed_ips</code> is omitted, all IPs are allowed. Requests must include HMAC signature.</small></p>

      <h4>Action Types</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>webhook</code> - Send an HTTP request to an external URL</li>
        <li class="pulse-list-item"><code>internal_action</code> - Run a Harmonic action (e.g., create_note)</li>
        <li class="pulse-list-item"><code>trigger_agent</code> - Trigger an AI agent with a task</li>
      </ul>

      <h4>Template Variables (Event Triggers)</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>{{event.type}}</code> - The event type</li>
        <li class="pulse-list-item"><code>{{event.actor.name}}</code> - Name of the triggering user</li>
        <li class="pulse-list-item"><code>{{subject.path}}</code> - URL path to the subject</li>
        <li class="pulse-list-item"><code>{{subject.text}}</code> - Text/content of the subject</li>
        <li class="pulse-list-item"><code>{{studio.handle}}</code> - Handle of the studio</li>
      </ul>

      <h4>Template Variables (Webhook Triggers)</h4>
      <ul class="pulse-list">
        <li class="pulse-list-item"><code>{{payload.*}}</code> - Access webhook JSON (e.g., <code>{{payload.data.value}}</code>)</li>
        <li class="pulse-list-item"><code>{{webhook.path}}</code> - The webhook path called</li>
        <li class="pulse-list-item"><code>{{webhook.source_ip}}</code> - IP address of the sender</li>
        <li class="pulse-list-item"><code>{{webhook.received_at}}</code> - Timestamp received</li>
      </ul>
    <% end %>
  </div>
</article>
