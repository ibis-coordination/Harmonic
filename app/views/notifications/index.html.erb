<%= render 'shared/show_resource_breadcrumbs', resource: nil, hide_studio_path: true do %>
  <%= octicon "inbox" %> Notifications
<% end %>

<p style="margin-bottom:24px;">
  <a href="/notifications/new" class="btn btn-secondary"><%= octicon "clock" %> Schedule Reminder</a>
</p>

<% if @scheduled_reminders.any? %>
  <section class="scheduled-reminders" style="margin-bottom:24px; padding:16px; border:1px solid var(--color-border-default);">
    <h3 style="margin-top:0; margin-bottom:12px;"><%= octicon "clock" %> Scheduled Reminders</h3>
    <ul style="list-style:none; padding:0; margin:0;">
      <% @scheduled_reminders.each do |nr| %>
        <li style="padding:10px 0; border-bottom:1px solid var(--color-border-muted); display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <strong><%= nr.notification.title %></strong>
            <% if nr.notification.body.present? %>
              <p style="margin:4px 0; color:var(--color-fg-muted);"><%= truncate(nr.notification.body, length: 150) %></p>
            <% end %>
            <small style="color:var(--color-fg-muted);"><%= octicon "calendar" %> <%= nr.scheduled_for.strftime("%b %d, %Y at %I:%M %p") %></small>
          </div>
          <div>
            <%= button_to "Delete",
                notifications_actions_delete_reminder_path(id: nr.id),
                method: :post,
                class: "btn btn-small",
                title: "Delete reminder",
                data: { confirm: "Delete this reminder?" } %>
          </div>
        </li>
      <% end %>
    </ul>
  </section>
<% end %>

<div data-controller="notification-actions">
  <% if @notification_recipients.empty? %>
    <% unless @scheduled_reminders.any? %>
      <p style="color:var(--color-fg-muted);"><em>All caught up!</em></p>
    <% end %>
  <% else %>
    <p style="margin-bottom:12px;">
      <span data-notification-summary>
        <% if @unread_count > 0 %>
          <strong data-notification-actions-target="unreadCount"><%= @unread_count %></strong> unread notifications
        <% else %>
          No unread notifications
        <% end %>
      </span>
      <% if @unread_count > 0 %>
        <button type="button"
                class="btn btn-small"
                data-action="click->notification-actions#markAllRead"
                data-notification-actions-target="markAllReadButton">
          Mark all read
        </button>
      <% end %>
    </p>
    <ul class="notification-list" style="list-style:none; padding:0; margin:0;">
      <% @notification_recipients.each do |recipient| %>
        <li data-notification-item="<%= recipient.id %>"
            style="padding:10px 0; border-bottom:1px solid var(--color-border-muted); <%= recipient.read? ? 'opacity:0.6;' : '' %>">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
            <div style="flex:1;">
              <% if recipient.notification.url.present? %>
                <a href="<%= recipient.notification.url %>">
                  <strong><%= recipient.notification.title %></strong>
                </a>
              <% else %>
                <strong><%= recipient.notification.title %></strong>
              <% end %>
              <% if recipient.notification.body.present? %>
                <p style="margin:4px 0; color:var(--color-fg-muted);"><%= truncate(recipient.notification.body, length: 200) %></p>
              <% end %>
              <small style="color:var(--color-fg-muted);"><%= time_ago_in_words(recipient.created_at) %> ago</small>
            </div>
            <div style="display:flex; gap:8px; flex-shrink:0;">
              <% unless recipient.read? %>
                <button type="button"
                        class="btn btn-small"
                        title="Mark as read"
                        data-action="click->notification-actions#markRead"
                        data-notification-id="<%= recipient.id %>">
                  <%= octicon "check" %>
                </button>
              <% end %>
              <% unless recipient.dismissed? %>
                <button type="button"
                        class="btn btn-small"
                        title="Dismiss"
                        data-action="click->notification-actions#dismiss"
                        data-notification-id="<%= recipient.id %>">
                  <%= octicon "x" %>
                </button>
              <% end %>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  <% end %>
</div>
