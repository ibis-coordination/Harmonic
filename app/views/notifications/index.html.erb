<%= render 'shared/pulse_breadcrumb', items: [
  [@current_tenant.subdomain, '/'],
  'Notifications'
] %>

<article class="pulse-notifications-page">
  <header class="pulse-notifications-header">
    <h1 class="pulse-page-title"><%= octicon 'inbox', height: 20 %> Notifications</h1>
    <div class="pulse-notifications-actions">
      <a href="/notifications/new" class="pulse-action-btn">
        <%= octicon 'clock', height: 14 %>
        Schedule Reminder
      </a>
    </div>
  </header>

  <% if @scheduled_reminders.any? %>
    <section class="pulse-scheduled-reminders">
      <h3><%= octicon 'clock', height: 16 %> Scheduled Reminders</h3>
      <ul class="pulse-reminder-list">
        <% @scheduled_reminders.each do |nr| %>
          <li class="pulse-reminder-item">
            <div class="pulse-reminder-content">
              <div class="pulse-reminder-title"><%= nr.notification.title %></div>
              <% if nr.notification.body.present? %>
                <p class="pulse-reminder-body"><%= truncate(nr.notification.body, length: 150) %></p>
              <% end %>
              <span class="pulse-reminder-time">
                <%= octicon 'calendar', height: 12 %>
                <%= nr.scheduled_for.strftime("%b %d, %Y at %I:%M %p") %>
              </span>
            </div>
            <div class="pulse-reminder-actions">
              <%= button_to "Delete",
                  notifications_actions_delete_reminder_path(id: nr.id),
                  method: :post,
                  class: "pulse-action-btn-small pulse-action-btn-danger",
                  title: "Delete reminder",
                  data: { confirm: "Delete this reminder?" } %>
            </div>
          </li>
        <% end %>
      </ul>
    </section>
  <% end %>

  <div data-controller="notification-actions">
    <% if @notification_recipients.empty? %>
      <% unless @scheduled_reminders.any? %>
        <div class="pulse-notifications-empty">
          <p><em>All caught up!</em></p>
        </div>
      <% end %>
    <% else %>
      <div class="pulse-notifications-summary">
        <span class="pulse-notifications-count" data-notification-summary>
          <% if @unread_count > 0 %>
            <strong data-notification-actions-target="unreadCount"><%= @unread_count %></strong> unread notifications
          <% else %>
            No unread notifications
          <% end %>
        </span>
        <% if @unread_count > 0 %>
          <button type="button"
                  class="pulse-action-btn-secondary"
                  data-action="click->notification-actions#dismissAll"
                  data-notification-actions-target="dismissAllButton">
            Dismiss all
          </button>
        <% end %>
      </div>

      <div class="pulse-notifications-grouped">
        <% @notifications_by_collective.each do |collective, recipients| %>
          <% studio_id = collective&.id || 'reminders' %>
          <% studio_name = collective&.name || 'Other' %>
          <details class="pulse-accordion" open data-collective-group="<%= studio_id %>">
            <summary class="pulse-accordion-header">
              <span class="pulse-accordion-title">
                <% if collective %>
                  <%= octicon 'home', height: 14 %>
                <% else %>
                  <%= octicon 'bell', height: 14 %>
                <% end %>
                <%= studio_name %>
                <span class="pulse-accordion-count">(<%= recipients.size %>)</span>
              </span>
              <div style="display: flex; align-items: center; gap: 8px;">
                <button type="button"
                        class="pulse-action-btn-small pulse-action-btn-secondary"
                        data-action="click->notification-actions#dismissForStudio"
                        data-studio-id="<%= studio_id %>"
                        style="font-size: 12px; padding: 4px 8px;">
                  Dismiss all
                </button>
                <span class="pulse-accordion-icon"><%= octicon 'chevron-right', height: 14 %></span>
              </div>
            </summary>
            <div class="pulse-accordion-content">
              <div class="pulse-notifications-list">
                <% recipients.each do |recipient| %>
                  <div data-notification-item="<%= recipient.id %>"
                       data-studio-id="<%= studio_id %>"
                       class="pulse-notification pulse-notification-unread">
                    <div class="pulse-notification-indicator"></div>
                    <div class="pulse-notification-content">
                      <% if recipient.notification.url.present? %>
                        <a href="<%= recipient.notification.url %>" class="pulse-notification-message">
                          <%= recipient.notification.title %>
                        </a>
                      <% else %>
                        <p class="pulse-notification-message"><%= recipient.notification.title %></p>
                      <% end %>
                      <% if recipient.notification.body.present? %>
                        <p class="pulse-notification-body" style="margin:4px 0 0 0; font-size:13px; color:var(--color-fg-muted);">
                          <%= truncate(recipient.notification.body, length: 200) %>
                        </p>
                      <% end %>
                      <span class="pulse-notification-time"><%= time_ago_in_words(recipient.created_at) %> ago</span>
                    </div>
                    <div class="pulse-notification-actions">
                      <button type="button"
                              class="pulse-action-btn-icon"
                              title="Dismiss"
                              data-action="click->notification-actions#dismiss"
                              data-notification-id="<%= recipient.id %>">
                        <%= octicon 'x', height: 14 %>
                      </button>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </details>
        <% end %>
      </div>
    <% end %>
  </div>
</article>
