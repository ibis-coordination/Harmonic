<%= render 'shared/pulse_breadcrumb', items: ['Search'] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'search', height: 14, class: 'pulse-resource-icon' %>
        Search
      </span>
    </div>
    <h1 class="pulse-resource-title">Search Results</h1>
  </header>

  <div class="pulse-resource-meta">
    <span><%= @total_count %> result<%= @total_count == 1 ? '' : 's' %></span>
    <% if @search.query.present? %>
      <span>for "<%= @search.query %>"</span>
    <% end %>
    <% if @search.superagent.present? %>
      <span>in <strong><%= @search.superagent.name %></strong></span>
    <% end %>
  </div>

  <div class="pulse-resource-body">
    <section class="pulse-settings-section">
      <%= form_with url: "/search", method: :get, local: true, class: 'pulse-form pulse-filters-form' do |form| %>
        <div class="pulse-form-row">
          <div class="pulse-form-group pulse-form-group-wide">
            <label class="pulse-form-label">Search</label>
            <%= form.text_field :q,
                value: params[:q],
                class: 'pulse-form-input',
                placeholder: 'budget type:note status:open studio:my-studio',
                style: 'font-family: monospace;' %>
            <p class="pulse-form-hint" style="margin-top: 0.25rem; font-size: 0.8rem; color: var(--color-fg-muted);">
              Use operators: <code>type:</code> <code>status:</code> <code>creator:</code> <code>studio:</code> <code>scene:</code> <code>sort:</code> <code>group:</code>
              <a href="#search-help" style="margin-left: 0.5rem;">Syntax help â†“</a>
            </p>
          </div>
          <div class="pulse-form-group pulse-form-group-submit">
            <%= form.submit 'Search', class: 'pulse-action-btn' %>
          </div>
        </div>
      <% end %>
    </section>

    <section class="pulse-settings-section">
      <% if @grouped_results.empty? %>
        <p class="pulse-empty-content"><em>No results found.</em></p>
      <% else %>
        <% @grouped_results.each do |group_key, items| %>
          <%= render 'shared/pulse_accordion', title: group_key || 'Results', open: true, count: items.length do %>
            <% if items.empty? %>
              <p class="pulse-empty-content"><em>No items in this group.</em></p>
            <% else %>
              <table class="pulse-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Location</th>
                    <th>Created</th>
                    <th>Deadline</th>
                    <th>Backlinks</th>
                  </tr>
                </thead>
                <tbody>
                  <% items.each do |item| %>
                    <tr>
                      <td><%= render 'shared/pulse_resource_link', resource: search_result_to_hash(item) %></td>
                      <td><%= item.superagent&.name || 'Unknown' %></td>
                      <td><%= timeago(item.created_at) %></td>
                      <td><%= timeago(item.deadline) %></td>
                      <td><%= item.backlink_count %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <% if @next_cursor.present? %>
        <div class="pulse-pagination" style="margin-top: 1rem;">
          <%= link_to 'Load more',
              "/search?#{@search.to_params.merge(cursor: @next_cursor).to_query}",
              class: 'pulse-action-btn pulse-action-btn-secondary' %>
        </div>
      <% end %>
    </section>

    <section id="search-help" class="pulse-settings-section" style="margin-top: 2rem;">
      <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Search Syntax</h3>
      <p style="font-size: 0.9rem; color: var(--color-fg-muted); margin-bottom: 1rem;">
        Use operators to filter, sort, and group results. Plain text searches content.
      </p>
      <table class="pulse-table" style="font-size: 0.85rem;">
        <thead>
          <tr><th>Operator</th><th>Values</th><th>Example</th></tr>
        </thead>
        <tbody>
          <tr><td><code>type:</code></td><td>note, decision, commitment</td><td><code>type:note</code></td></tr>
          <tr><td><code>subtype:</code></td><td>comment</td><td><code>-subtype:comment</code></td></tr>
          <tr><td><code>status:</code></td><td>open, closed</td><td><code>status:open</code></td></tr>
          <tr><td><code>studio:</code></td><td>studio handle</td><td><code>studio:my-studio</code></td></tr>
          <tr><td><code>scene:</code></td><td>scene handle</td><td><code>scene:planning</code></td></tr>
          <tr><td><code>creator:</code></td><td>@handle</td><td><code>creator:@alice</code></td></tr>
          <tr><td><code>read-by:</code></td><td>@handle</td><td><code>-read-by:@myhandle</code></td></tr>
          <tr><td><code>voter:</code></td><td>@handle</td><td><code>-voter:@myhandle</code></td></tr>
          <tr><td><code>participant:</code></td><td>@handle</td><td><code>participant:@myhandle</code></td></tr>
          <tr><td><code>mentions:</code></td><td>@handle</td><td><code>mentions:@myhandle</code></td></tr>
          <tr><td><code>replying-to:</code></td><td>@handle</td><td><code>replying-to:@myhandle</code></td></tr>
          <tr><td><code>min-*/max-*:</code></td><td>links, backlinks, comments, readers, voters, participants</td><td><code>min-backlinks:1</code></td></tr>
          <tr><td><code>critical-mass-achieved:</code></td><td>true, false</td><td><code>critical-mass-achieved:true</code></td></tr>
          <tr><td><code>sort:</code></td><td>newest, oldest, updated, deadline, relevance</td><td><code>sort:newest</code></td></tr>
          <tr><td><code>group:</code></td><td>type, status, date, week, month, none</td><td><code>group:type</code></td></tr>
          <tr><td><code>cycle:</code></td><td>today, this-week, last-month, etc.</td><td><code>cycle:this-week</code></td></tr>
          <tr><td><code>after:</code></td><td>YYYY-MM-DD or -Nd/-Nw/-Nm/-Ny</td><td><code>after:-7d</code></td></tr>
          <tr><td><code>before:</code></td><td>YYYY-MM-DD or +Nd/+Nw/+Nm/+Ny</td><td><code>before:+2w</code></td></tr>
          <tr><td><code>limit:</code></td><td>1-100</td><td><code>limit:25</code></td></tr>
        </tbody>
      </table>
      <p style="font-size: 0.85rem; color: var(--color-fg-muted); margin-top: 0.75rem;">
        <strong>Examples:</strong>
        <code style="display: block; margin: 0.25rem 0;">budget type:note status:open sort:newest</code>
        <code style="display: block; margin: 0.25rem 0;">type:decision -voter:@myhandle status:open</code>
        <code style="display: block; margin: 0.25rem 0;">studio:team-alpha after:-7d -read-by:@myhandle</code>
      </p>
    </section>
  </div>
</article>
