<%# Shared YAML reference for automation forms %>
<%# Local variables: %>
<%#   automation_type: :agent or :studio (default: :studio) %>
<% automation_type ||= :studio %>

<%= render 'shared/pulse_accordion', title: 'YAML Reference', open: false do %>
  <h4>Basic Structure</h4>
  <% if automation_type == :agent %>
  <pre class="pulse-code-block"><code>name: "Automation Name"
description: "What this automation does"

trigger:
  type: event              # event, schedule, webhook, or manual
  event_type: note.created # Required for event triggers
  mention_filter: self     # Optional: self or any_agent

# Optional conditions to filter events
conditions:
  - field: "subject.text"
    operator: "contains"
    value: "urgent"

# Task prompt sent to the AI agent
task: |
  You were triggered by {{event.actor.name}}.
  Navigate to {{subject.path}} and respond.

max_steps: 20  # Optional, defaults to agent's configured max</code></pre>
  <% else %>
  <pre class="pulse-code-block"><code>name: "Automation Name"
description: "What this automation does"

trigger:
  type: event              # event, schedule, webhook, or manual
  event_type: note.created # Required for event triggers

# Optional conditions to filter events
conditions:
  - field: "subject.text"
    operator: "contains"
    value: "urgent"

# Actions to execute
actions:
  - type: webhook          # or internal_action, trigger_agent
    url: "https://example.com/hook"
    payload:
      text: "{{subject.title}}"</code></pre>
  <% end %>

  <h4>Trigger Types</h4>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>event</code> - Trigger when a specific event occurs</li>
    <li class="pulse-list-item"><code>schedule</code> - Trigger on a cron schedule</li>
    <li class="pulse-list-item"><code>webhook</code> - Trigger via incoming webhook</li>
    <li class="pulse-list-item"><code>manual</code> - Trigger manually via button click</li>
  </ul>

  <h4>Event Types</h4>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>note.created</code> - A note was created</li>
    <li class="pulse-list-item"><code>comment.created</code> - A comment was added</li>
    <li class="pulse-list-item"><code>reply.created</code> - A reply was added to a comment</li>
    <li class="pulse-list-item"><code>decision.created</code> - A decision was created</li>
    <li class="pulse-list-item"><code>commitment.created</code> - A commitment was created</li>
    <li class="pulse-list-item"><code>commitment.critical_mass</code> - A commitment reached critical mass</li>
  </ul>

  <% if automation_type == :agent %>
  <h4>Mention Filters</h4>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>self</code> - Only trigger when this agent is @mentioned</li>
    <li class="pulse-list-item"><code>any_agent</code> - Trigger when any agent is mentioned</li>
    <li class="pulse-list-item"><em>(omit)</em> - Trigger on all matching events</li>
  </ul>
  <% end %>

  <h4>Schedule Configuration</h4>
  <pre class="pulse-code-block"><code>trigger:
  type: schedule
  cron: "0 9 * * *"           # Run at 9:00 AM daily
  timezone: "America/New_York" # Optional, defaults to UTC</code></pre>
  <p><strong>Cron format:</strong> <code>minute hour day-of-month month day-of-week</code></p>
  <table class="pulse-table">
    <thead><tr><th>Expression</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>0 9 * * *</code></td><td>Daily at 9:00 AM</td></tr>
      <tr><td><code>0 9 * * 1</code></td><td>Every Monday at 9:00 AM</td></tr>
      <tr><td><code>0 9 1 * *</code></td><td>First day of month at 9:00 AM</td></tr>
      <tr><td><code>0 */2 * * *</code></td><td>Every 2 hours</td></tr>
    </tbody>
  </table>

  <h4>Webhook Configuration</h4>
  <pre class="pulse-code-block"><code>trigger:
  type: webhook
  allowed_ips:         # Optional: restrict to specific IPs
    - "10.0.0.1"       # Exact IP address
    - "192.168.1.0/24" # CIDR range</code></pre>
  <p><small>After creation, you'll receive a unique webhook URL and secret. External systems must sign requests with HMAC-SHA256.</small></p>

  <h4>Manual Trigger Configuration</h4>
  <pre class="pulse-code-block"><code>trigger:
  type: manual
  inputs:
    report_date:
      label: "Report Date"
      type: string        # string, number, or boolean
      default: "today"
    include_draft:
      label: "Include Drafts"
      type: boolean
      default: false</code></pre>
  <p><small>When triggered, users can provide values for these inputs. Access them via <code>{{inputs.report_date}}</code>.</small></p>

  <% if automation_type == :studio %>
  <h4>Action Types</h4>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>webhook</code> - Send an HTTP request to an external URL</li>
    <li class="pulse-list-item"><code>internal_action</code> - Create content in the studio</li>
    <li class="pulse-list-item"><code>trigger_agent</code> - Trigger an AI agent with a task</li>
  </ul>

  <h4>Webhook Action</h4>
  <pre class="pulse-code-block"><code>actions:
  - type: webhook
    url: "https://hooks.slack.com/services/..."
    method: POST           # Optional: GET, POST, PUT, PATCH, DELETE
    headers:               # Optional
      Authorization: "Bearer {{secrets.token}}"
    payload:               # Request body
      text: "New: {{subject.title}}"
      actor: "{{event.actor.name}}"
    timeout: 30            # Optional: seconds</code></pre>

  <h4>Internal Actions</h4>
  <p>Create content directly in the studio. Resources created are tracked with automation attribution.</p>

  <table class="pulse-table">
    <thead><tr><th>Action</th><th>Required Param</th><th>Optional Params</th></tr></thead>
    <tbody>
      <tr><td><code>create_note</code></td><td><code>text</code></td><td><code>title</code></td></tr>
      <tr><td><code>create_decision</code></td><td><code>question</code></td><td><code>description</code>, <code>deadline</code>, <code>options</code></td></tr>
      <tr><td><code>create_commitment</code></td><td><code>title</code></td><td><code>description</code>, <code>critical_mass</code>, <code>deadline</code>, <code>limit</code></td></tr>
    </tbody>
  </table>

  <pre class="pulse-code-block"><code># Create a note
actions:
  - type: internal_action
    action: create_note
    params:
      text: "Summary of {{subject.title}}"
      title: "Auto-generated note"  # Optional

# Create a decision
  - type: internal_action
    action: create_decision
    params:
      question: "Should we proceed with {{subject.title}}?"
      description: "Auto-generated"  # Optional
      deadline: "2024-12-31"         # Optional
      options:                       # Optional
        - "Yes"
        - "No"
        - "Discuss further"

# Create a commitment
  - type: internal_action
    action: create_commitment
    params:
      title: "Follow up on {{subject.title}}"
      description: "Auto-generated"  # Optional
      critical_mass: 3               # Optional (default: 1)
      deadline: "2024-12-31"         # Optional
      limit: 10                      # Optional max participants</code></pre>

  <h4>Trigger Agent Action</h4>
  <pre class="pulse-code-block"><code>actions:
  - type: trigger_agent
    agent_id: "agent-uuid-here"   # Required
    task: |                       # Required
      Review the content at {{subject.path}}.
      Post a summary of the key points.
    max_steps: 15                 # Optional</code></pre>
  <% end %>

  <h4>Template Variables</h4>
  <p><strong>Event triggers:</strong></p>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>{{event.type}}</code> - The event type</li>
    <li class="pulse-list-item"><code>{{event.actor.name}}</code> - Name of the triggering user</li>
    <li class="pulse-list-item"><code>{{event.actor.handle}}</code> - Handle of the triggering user</li>
    <li class="pulse-list-item"><code>{{subject.path}}</code> - URL path to the subject</li>
    <li class="pulse-list-item"><code>{{subject.title}}</code> - Title of the subject</li>
    <li class="pulse-list-item"><code>{{subject.text}}</code> - Text content of the subject</li>
    <li class="pulse-list-item"><code>{{studio.name}}</code> - Name of the studio</li>
    <li class="pulse-list-item"><code>{{studio.handle}}</code> - Handle of the studio</li>
  </ul>

  <p><strong>Webhook triggers:</strong></p>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>{{payload.*}}</code> - Access webhook JSON (e.g., <code>{{payload.data.value}}</code>)</li>
    <li class="pulse-list-item"><code>{{webhook.path}}</code> - The webhook path called</li>
    <li class="pulse-list-item"><code>{{webhook.source_ip}}</code> - IP address of the sender</li>
    <li class="pulse-list-item"><code>{{webhook.received_at}}</code> - Timestamp received</li>
  </ul>

  <p><strong>Manual triggers:</strong></p>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>{{inputs.*}}</code> - Access input values (e.g., <code>{{inputs.report_date}}</code>)</li>
    <li class="pulse-list-item"><code>{{triggered_at}}</code> - Timestamp when run was triggered</li>
    <li class="pulse-list-item"><code>{{triggered_by}}</code> - ID of the user who triggered the run</li>
  </ul>

  <p><strong>Schedule triggers:</strong></p>
  <ul class="pulse-list">
    <li class="pulse-list-item"><code>{{schedule.triggered_at}}</code> - When the schedule fired</li>
  </ul>

  <h4>Condition Operators</h4>
  <table class="pulse-table">
    <thead><tr><th>Operator</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>==</code>, <code>!=</code></td><td>Equal, not equal</td></tr>
      <tr><td><code>></code>, <code>>=</code>, <code><</code>, <code><=</code></td><td>Numeric comparisons</td></tr>
      <tr><td><code>contains</code>, <code>not_contains</code></td><td>String contains substring</td></tr>
      <tr><td><code>matches</code>, <code>not_matches</code></td><td>Regex pattern matching</td></tr>
    </tbody>
  </table>
<% end %>
