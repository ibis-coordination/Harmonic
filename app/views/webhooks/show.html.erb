<%= render 'shared/pulse_breadcrumb', items: [
  [@current_superagent.name, @current_superagent.path],
  ['Settings', @current_superagent.path + '/settings'],
  ['Webhooks', @current_superagent.path + '/settings/webhooks'],
  @webhook.name
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'webhook', height: 14, class: 'pulse-resource-icon' %>
        Webhook
      </span>
    </div>
    <h1 class="pulse-resource-title"><%= @webhook.name %></h1>
  </header>

  <div class="pulse-resource-body">
    <section class="pulse-settings-section">
      <table class="pulse-table">
        <tr>
          <th style="width:120px;">URL</th>
          <td class="pulse-monospace" style="word-break:break-all;"><%= @webhook.url %></td>
        </tr>
        <tr>
          <th>Status</th>
          <td>
            <% if @webhook.enabled? %>
              <span class="pulse-tag pulse-tag-success">Enabled</span>
            <% else %>
              <span class="pulse-tag">Disabled</span>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Events</th>
          <td>
            <% if @webhook.events.include?("*") %>
              <span class="pulse-tag">All events</span>
            <% else %>
              <% @webhook.events.each do |event| %>
                <span class="pulse-tag"><%= event %></span>
              <% end %>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Secret</th>
          <td>
            <code class="pulse-monospace"><%= @webhook.secret.first(8) %>...</code>
            <span class="pulse-muted">(partial, for security)</span>
          </td>
        </tr>
        <tr>
          <th>Created</th>
          <td><%= @webhook.created_at.strftime("%Y-%m-%d %H:%M") %></td>
        </tr>
      </table>
    </section>

    <section class="pulse-settings-section pulse-action-row">
      <form action="<%= "/studios/#{@current_superagent.handle}/settings/webhooks/#{@webhook.truncated_id}/actions/test_webhook" %>" method="post" style="display:inline;">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="pulse-action-btn pulse-action-btn-primary">
          <%= octicon "zap" %> Send Test
        </button>
      </form>

      <% if @webhook.enabled? %>
        <form action="<%= "/studios/#{@current_superagent.handle}/settings/webhooks/#{@webhook.truncated_id}/actions/update_webhook" %>" method="post" style="display:inline;">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :enabled, "false" %>
          <button type="submit" class="pulse-action-btn">Disable</button>
        </form>
      <% else %>
        <form action="<%= "/studios/#{@current_superagent.handle}/settings/webhooks/#{@webhook.truncated_id}/actions/update_webhook" %>" method="post" style="display:inline;">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :enabled, "true" %>
          <button type="submit" class="pulse-action-btn pulse-action-btn-success">Enable</button>
        </form>
      <% end %>

      <form action="<%= "/studios/#{@current_superagent.handle}/settings/webhooks/#{@webhook.truncated_id}/actions/delete_webhook" %>" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this webhook?');">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="pulse-action-btn pulse-action-btn-danger">Delete</button>
      </form>
    </section>

    <%= render 'shared/pulse_accordion', title: 'Recent Deliveries', open: true, count: @recent_deliveries.size do %>
      <% if @recent_deliveries.empty? %>
        <p class="pulse-empty-content"><em>No deliveries yet.</em></p>
      <% else %>
        <table class="pulse-table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Status</th>
              <th>Response</th>
              <th>Attempts</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_deliveries.each do |delivery| %>
              <tr>
                <td><code><%= delivery.event&.event_type || "unknown" %></code></td>
                <td>
                  <% case delivery.status %>
                  <% when "success" %>
                    <span class="pulse-tag pulse-tag-success">Success</span>
                  <% when "failed" %>
                    <span class="pulse-tag pulse-tag-danger">Failed</span>
                  <% when "retrying" %>
                    <span class="pulse-tag pulse-tag-warning">Retrying</span>
                  <% else %>
                    <span class="pulse-tag">Pending</span>
                  <% end %>
                </td>
                <td>
                  <% if delivery.response_code %>
                    <code><%= delivery.response_code %></code>
                  <% elsif delivery.error_message %>
                    <span class="pulse-error-text"><%= truncate(delivery.error_message, length: 50) %></span>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td><%= delivery.attempt_count %></td>
                <td><%= time_ago_in_words(delivery.created_at) %> ago</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>
  </div>
</article>
