<%
base_path = "/u/#{@target_user.handle}/settings/webhooks/#{@webhook.truncated_id}"
%>

<%= render 'shared/pulse_breadcrumb', items: [
  ['Home', '/'],
  [@target_user.display_name, "/u/#{@target_user.handle}"],
  ['Settings', "/u/#{@target_user.handle}/settings"],
  ['Webhooks', "/u/#{@target_user.handle}/settings/webhooks"],
  @webhook.name
] %>

<article class="pulse-resource-detail">
  <header class="pulse-resource-header">
    <div class="pulse-resource-header-top">
      <span class="pulse-resource-type-label">
        <%= octicon 'webhook', height: 14, class: 'pulse-resource-icon' %>
        Webhook
      </span>
    </div>
    <h1 class="pulse-resource-title"><%= @webhook.name %></h1>
  </header>

  <div class="pulse-resource-body">
    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Details</h2>
      <table class="pulse-table">
        <tr>
          <th style="width:100px;">URL</th>
          <td><code class="pulse-monospace"><%= @webhook.url %></code></td>
        </tr>
        <tr>
          <th>Status</th>
          <td>
            <% if @webhook.enabled? %>
              <span class="pulse-tag pulse-tag-success">Enabled</span>
            <% else %>
              <span class="pulse-tag">Disabled</span>
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Events</th>
          <td><%= @webhook.events.join(", ") %></td>
        </tr>
        <tr>
          <th>Secret</th>
          <td>
            <code class="pulse-monospace"><%= @webhook.secret.first(8) %>...</code>
            <span class="pulse-muted">(partial)</span>
          </td>
        </tr>
        <tr>
          <th>Created</th>
          <td><%= @webhook.created_at.strftime("%Y-%m-%d %H:%M") %></td>
        </tr>
      </table>
    </section>

    <%= render 'shared/pulse_accordion', title: 'Recent Deliveries', open: true, count: @recent_deliveries.size do %>
      <% if @recent_deliveries.empty? %>
        <p class="pulse-empty-content"><em>No deliveries yet.</em></p>
      <% else %>
        <table class="pulse-table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Status</th>
              <th>Response</th>
              <th>Attempts</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_deliveries.each do |delivery| %>
              <% event = @events_by_id[delivery.event_id] %>
              <tr>
                <td><code><%= event&.event_type || "unknown" %></code></td>
                <td>
                  <% case delivery.status %>
                  <% when "success" %>
                    <span class="pulse-tag pulse-tag-success">Success</span>
                  <% when "failed" %>
                    <span class="pulse-tag pulse-tag-danger">Failed</span>
                  <% when "retrying" %>
                    <span class="pulse-tag pulse-tag-warning">Retrying</span>
                  <% else %>
                    <span class="pulse-tag">Pending</span>
                  <% end %>
                </td>
                <td>
                  <% if delivery.response_code %>
                    <code><%= delivery.response_code %></code>
                  <% elsif delivery.error_message %>
                    <span class="pulse-error-text"><%= truncate(delivery.error_message, length: 30) %></span>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td><%= delivery.attempt_count %></td>
                <td><%= time_ago_in_words(delivery.created_at) %> ago</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>

    <section class="pulse-settings-section">
      <h2 class="pulse-section-title">Actions</h2>
      <div class="pulse-action-row">
        <%= form_tag "#{base_path}/actions/test_webhook", method: :post, style: "display:inline;" do %>
          <button type="submit" class="pulse-action-btn">
            <%= octicon "zap" %> Send Test
          </button>
        <% end %>

        <%= form_tag "#{base_path}/actions/delete_webhook", method: :post, style: "display:inline;" do %>
          <button type="submit" class="pulse-action-btn pulse-action-btn-danger" onclick="return confirm('Are you sure you want to delete this webhook?')">
            Delete Webhook
          </button>
        <% end %>
      </div>
    </section>
  </div>
</article>
