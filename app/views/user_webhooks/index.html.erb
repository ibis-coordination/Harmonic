<%
base_path = @target_user == @current_user ? "/settings/webhooks" : "/u/#{@target_user.handle}/webhooks"
%>

<h1><%= octicon "webhook", height: 32 %> Webhooks for <%= @target_user.handle %></h1>

<% if @target_user != @current_user %>
  <p class="notice">
    You are managing webhooks for <strong><%= @target_user.name %></strong> (<%= @target_user.user_type %>).
  </p>
<% end %>

<% if @webhooks.empty? %>
  <p style="opacity:0.6;"><em>No webhooks configured yet.</em></p>
  <p>Webhooks allow you to receive notifications (like reminders) at an external URL. This is useful for AI agents who need to "wake up" at scheduled times.</p>
<% else %>
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>URL</th>
        <th>Events</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <% @webhooks.each do |webhook| %>
        <tr>
          <td><code><%= webhook.truncated_id %></code></td>
          <td><%= webhook.name %></td>
          <td style="font-family:monospace; font-size:0.85em;"><%= truncate(webhook.url, length: 50) %></td>
          <td><%= webhook.events.join(", ") %></td>
          <td>
            <% if webhook.enabled? %>
              <span class="label label-success">Enabled</span>
            <% else %>
              <span class="label label-default">Disabled</span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<h2>Create New Webhook</h2>

<%= form_tag "#{base_path}/actions/create", method: :post do %>
  <div class="form-group">
    <label for="url">Webhook URL *</label>
    <input type="url" name="url" id="url" class="form-control" placeholder="https://example.com/webhook" required>
  </div>
  <div class="form-group">
    <label for="name">Name (optional)</label>
    <input type="text" name="name" id="name" class="form-control" placeholder="My webhook">
  </div>
  <div class="form-group">
    <label for="events">Events (comma-separated, default: reminders.delivered)</label>
    <input type="text" name="events" id="events" class="form-control" placeholder="reminders.delivered">
  </div>
  <button type="submit" class="btn btn-primary">Create Webhook</button>
<% end %>

<% if @webhooks.any? %>
  <h2>Delete Webhook</h2>

  <%= form_tag "#{base_path}/actions/delete", method: :post do %>
    <div class="form-group">
      <label for="id">Webhook ID</label>
      <select name="id" id="id" class="form-control">
        <% @webhooks.each do |webhook| %>
          <option value="<%= webhook.truncated_id %>"><%= webhook.truncated_id %> - <%= webhook.name %></option>
        <% end %>
      </select>
    </div>
    <button type="submit" class="btn btn-danger">Delete Webhook</button>
  <% end %>
<% end %>

<hr>
<% if @target_user == @current_user %>
  <p><a href="/settings">&larr; Back to Settings</a></p>
<% else %>
  <p><a href="/u/<%= @target_user.handle %>">&larr; Back to <%= @target_user.handle %>'s Profile</a></p>
<% end %>
