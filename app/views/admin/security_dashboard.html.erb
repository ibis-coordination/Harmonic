<%= render 'shared/pulse_breadcrumb', items: [
  [@current_tenant.subdomain, '/'],
  ['Admin', '/admin'],
  'Security'
] %>

<h1 class="pulse-page-title">
  <%= octicon 'shield', height: 24 %> Security Dashboard
</h1>

<% unless @log_exists %>
  <div class="pulse-alert pulse-alert-warning">
    <%= octicon 'alert', height: 16 %>
    Security audit log file not found. Events will appear here once security-relevant actions occur.
  </div>
<% end %>

<%= render 'shared/pulse_accordion', title: 'Filters', icon: 'filter', open: @event_type.present? || @ip_filter.present? || @email_filter.present? || @time_range != "24h" do %>
  <%= form_with url: '/admin/security', method: :get, local: true, class: 'pulse-form' do |form| %>
    <div class="pulse-form-row">
      <div class="pulse-form-group">
        <label class="pulse-form-label">Event Type</label>
        <%= form.select :event_type,
            options_for_select([['All Events', '']] + SecurityAuditLogReader::EVENT_TYPES.map { |t| [t.titleize, t] }, @event_type),
            {}, { class: 'pulse-form-select' } %>
      </div>
      <div class="pulse-form-group">
        <label class="pulse-form-label">IP Address</label>
        <%= form.text_field :ip, value: @ip_filter, class: 'pulse-form-input', placeholder: 'e.g. 192.168.1.1' %>
      </div>
      <div class="pulse-form-group">
        <label class="pulse-form-label">Email</label>
        <%= form.text_field :email, value: @email_filter, class: 'pulse-form-input', placeholder: 'user@example.com' %>
      </div>
      <div class="pulse-form-group">
        <label class="pulse-form-label">Time Range</label>
        <%= form.select :time_range,
            options_for_select([['Last Hour', '1h'], ['Last 24 Hours', '24h'], ['Last 7 Days', '7d'], ['Last 30 Days', '30d'], ['All Time', 'all']], @time_range),
            {}, { class: 'pulse-form-select' } %>
      </div>
      <div class="pulse-form-group pulse-form-group-submit">
        <%= form.submit 'Apply', class: 'pulse-action-btn' %>
        <% if @event_type.present? || @ip_filter.present? || @email_filter.present? || @time_range != "24h" %>
          <a href="/legacy-admin/security" class="pulse-action-btn-secondary">Clear</a>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>

<%= render 'shared/pulse_accordion', title: 'Summary', icon: 'graph', count: @summary.values.sum, open: true do %>
  <div class="pulse-table-wrapper">
    <table class="pulse-table">
      <thead>
        <tr>
          <th>Event Type</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="/legacy-admin/security?event_type=login_success&time_range=<%= @time_range %>"><%= octicon 'sign-in', height: 14 %> Login Success</a></td>
          <td><%= @summary['login_success'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=login_failure&time_range=<%= @time_range %>"><%= octicon 'x-circle', height: 14 %> Login Failure</a></td>
          <td><%= @summary['login_failure'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=logout&time_range=<%= @time_range %>"><%= octicon 'sign-out', height: 14 %> Logout</a></td>
          <td><%= @summary['logout'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=password_reset_requested&time_range=<%= @time_range %>"><%= octicon 'key', height: 14 %> Password Reset Requested</a></td>
          <td><%= @summary['password_reset_requested'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=password_changed&time_range=<%= @time_range %>"><%= octicon 'shield-check', height: 14 %> Password Changed</a></td>
          <td><%= @summary['password_changed'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=permission_denied&time_range=<%= @time_range %>"><%= octicon 'stop', height: 14 %> Permission Denied</a></td>
          <td><%= @summary['permission_denied'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=admin_action&time_range=<%= @time_range %>"><%= octicon 'tools', height: 14 %> Admin Action</a></td>
          <td><%= @summary['admin_action'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=rate_limited&time_range=<%= @time_range %>"><%= octicon 'clock', height: 14 %> Rate Limited</a></td>
          <td><%= @summary['rate_limited'] %></td>
        </tr>
        <tr>
          <td><a href="/legacy-admin/security?event_type=ip_blocked&time_range=<%= @time_range %>"><%= octicon 'shield-x', height: 14 %> IP Blocked</a></td>
          <td><%= @summary['ip_blocked'] %></td>
        </tr>
      </tbody>
    </table>
  </div>
<% end %>

<%= render 'shared/pulse_accordion', title: 'Security Events', icon: 'list-unordered', count: @total_count, open: true do %>
  <% if @recent_events.any? %>
    <div class="pulse-table-wrapper">
      <table class="pulse-table">
        <thead>
          <tr>
            <th><%= security_sort_link('timestamp', 'Time') %></th>
            <th><%= security_sort_link('event', 'Event') %></th>
            <th>Email</th>
            <th>IP</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_events.each do |event| %>
            <tr>
              <td>
                <% if event['timestamp'] %>
                  <a href="/legacy-admin/security/events/<%= event['line_number'] %>">
                    <%= timeago(Time.zone.parse(event['timestamp'])) %>
                  </a>
                <% else %>
                  -
                <% end %>
              </td>
              <td>
                <a href="/legacy-admin/security?event_type=<%= event['event'] %>&time_range=<%= @time_range %>">
                  <code class="pulse-code"><%= event['event'] %></code>
                </a>
              </td>
              <td>
                <% if event['email'].present? %>
                  <a href="/legacy-admin/security?email=<%= event['email'] %>&time_range=<%= @time_range %>"><%= event['email'] %></a>
                <% else %>
                  -
                <% end %>
              </td>
              <td>
                <% if event['ip'].present? %>
                  <a href="/legacy-admin/security?ip=<%= event['ip'] %>&time_range=<%= @time_range %>">
                    <code class="pulse-code"><%= event['ip'] %></code>
                  </a>
                <% else %>
                  -
                <% end %>
              </td>
              <td>
                <% details = event.except('timestamp', 'event', 'environment', 'email', 'ip', 'user_id', 'line_number') %>
                <% if details.any? %>
                  <% details.each do |key, value| %>
                    <span class="pulse-tag"><%= key %>: <%= value.to_s.truncate(30) %></span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @total_pages > 1 %>
      <div class="pulse-pagination" style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
        <% base_params = request.query_parameters.except("page") %>
        <% if @page > 1 %>
          <a href="/legacy-admin/security?<%= base_params.merge(page: @page - 1).to_query %>" class="pulse-action-btn-secondary">
            <%= octicon 'chevron-left', height: 14 %> Previous
          </a>
        <% end %>
        <span style="color: var(--color-fg-muted);">
          Page <%= @page %> of <%= @total_pages %> (<%= @total_count %> events)
        </span>
        <% if @page < @total_pages %>
          <a href="/legacy-admin/security?<%= base_params.merge(page: @page + 1).to_query %>" class="pulse-action-btn-secondary">
            Next <%= octicon 'chevron-right', height: 14 %>
          </a>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p class="pulse-empty-message">No security events match the current filters.</p>
  <% end %>
<% end %>
